<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>💎</text></svg>" />
    <title>Counet PM</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'IBM Plex Mono', monospace;
            background-color: #202020;
            color: #D3D3D3;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            margin: 0;
            box-sizing: border-box;
        }

        .container {
            padding-left: 20px;
            padding-right: 20px;
            padding-top: 20px;
            min-height: calc(100vh - 40px);
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #1e2328 0%, #2d3748 100%);
            padding: 10px 20px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 72px;
            margin-bottom: 20px;
            border-bottom: 2px solid #4a5568;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            position: relative;
        }

        .header-left-section {
            display: flex;
            align-items: center;
        }

        .header-right-section {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }




        .header-info-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
        }

        .header-info-label {
            color: #a0aec0;
            font-weight: 500;
        }

        .header-wallet-address {
            color: #68d391; /* Vert pour indiquer que c'est actif */
            font-family: 'IBM Plex Mono', monospace;
            font-weight: 600;
            background: rgba(104, 211, 145, 0.1);
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            border: 1px solid rgba(104, 211, 145, 0.3);
            transition: all 0.2s ease;
            user-select: all; /* Permet la sélection pour copier */
        }

        .header-wallet-address:hover {
            background: rgba(104, 211, 145, 0.15);
            border-color: rgba(104, 211, 145, 0.5);
            transform: scale(1.02);
        }

        .header-timestamp {
            color: #e2e8f0;
            font-weight: 500;
            font-family: 'IBM Plex Mono', monospace;
        }

        .header h1 {
            margin: 0;
            font-size: 2.2em;
            font-family: 'IBM Plex Mono', monospace;
            color: white;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            text-transform: uppercase;
            letter-spacing: 2px;
            animation: super-aziz-glow 3s ease-in-out infinite;
            flex-grow: 1;
            text-align: center;
            display: inline-block;
        }

        @keyframes super-aziz-glow {
            0%, 100% { 
                text-shadow: 
                    0 2px 4px rgba(0, 0, 0, 0.3),
                    0 0 10px rgba(255, 255, 255, 0.3);
            }
            50% { 
                text-shadow: 
                    0 2px 4px rgba(0, 0, 0, 0.3),
                    0 0 20px rgba(255, 255, 255, 0.6),
                    0 0 30px rgba(255, 255, 255, 0.4);
            }
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #e2e8f0;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .status-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #48bb78;
            animation: pulse 2s infinite;
            box-shadow: 0 0 8px rgba(72, 187, 120, 0.5);
        }

        .status-dot.offline {
            background: #f56565;
            box-shadow: 0 0 8px rgba(245, 101, 101, 0.5);
        }

        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
            100% { opacity: 1; transform: scale(1); }
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 20px;
            flex-grow: 0;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border: 1px solid #4a5568;
            transition: all 0.3s ease;
        }

        .card:hover {
            border-color: #63b3ed;
            box-shadow: 0 6px 20px rgba(99, 179, 237, 0.1);
        }

        .main-card {
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
            width: 100%;
        }

        .main-card h2 {
            font-size: 1.3rem;
            margin-bottom: 16px;
        }
        
        #positionsContent {
            display: flex;
            flex-direction: column;
            gap: 30px;
            width: 100%;
        }

        .card h2 {
            color: #e2e8f0;
            margin-bottom: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 16px;
        }

        .summary-item {
            text-align: center;
            padding: 12px;
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
            border-radius: 6px;
            border: 1px solid #718096;
            transition: all 0.3s ease;
        }

        .summary-item:hover {
            border-color: #63b3ed;
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(99, 179, 237, 0.2);
        }

        .summary-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #e2e8f0;
            margin-bottom: 4px;
        }

        .summary-label {
            font-size: 0.75rem;
            color: #a0aec0;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .positions-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        }

        .positions-table th,
        .positions-table td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid #4a5568;
        }

        .positions-table th {
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
            font-weight: 700;
            color: #e2e8f0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.85rem;
            text-align: center;
        }

        .positions-table td {
            color: #d3d3d3;
            font-weight: 500;
        }

        .positions-table td.center {
            text-align: center;
        }

        .positions-table td.right {
            text-align: right;
        }

        .positions-table tr:hover {
            background: rgba(99, 179, 237, 0.1);
        }

        .position-status {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            width: 70px;
            text-align: center;
            display: inline-block;
        }

        .position-status.open {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(72, 187, 120, 0.3);
        }

        .position-status.closed {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(245, 101, 101, 0.3);
        }

        .dex-badge {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-block;
            width: 150px;
            min-height: 35px;
            text-align: center;
            white-space: normal;
            overflow: visible;
            border: 1px solid rgba(255, 255, 255, 0.1);
            line-height: 1.2;
        }

        .dex-badge.raydium {
            background: rgba(135, 206, 235, 0.2);
            color: white;
            border-color: rgba(135, 206, 235, 0.3);
        }

        .dex-badge.raydium-cpmm {
            background: rgba(30, 58, 138, 0.2);
            color: white;
            border-color: rgba(30, 58, 138, 0.3);
        }

        .dex-badge.jupiter {
            background: rgba(251, 191, 36, 0.2);
            color: white;
            border-color: rgba(251, 191, 36, 0.3);
        }

        .dex-badge.orca {
            background: rgba(6, 182, 212, 0.2);
            color: white;
            border-color: rgba(6, 182, 212, 0.3);
        }

        .dex-badge.serum {
            background: rgba(16, 185, 129, 0.2);
            color: white;
            border-color: rgba(16, 185, 129, 0.3);
        }

        .dex-badge.pump {
            background: rgba(249, 115, 22, 0.2);
            color: white;
            border-color: rgba(249, 115, 22, 0.3);
        }

        .dex-badge.meteora {
            background: rgba(255, 255, 0, 0.25);
            color: white;
            border-color: rgba(255, 255, 0, 0.4);
        }

        .dex-badge.other {
            background: rgba(107, 114, 128, 0.2);
            color: white;
            border-color: rgba(107, 114, 128, 0.3);
        }

        .dex-badge.unknown {
            background: rgba(74, 85, 104, 0.2);
            color: white;
            border-color: rgba(113, 128, 150, 0.3);
        }

        .pnl-positive {
            color: #68d391;
            font-weight: 700;
        }

        .pnl-negative {
            color: #fc8181;
            font-weight: 700;
        }

        .transactions-list {
            max-height: 450px;
            overflow-y: auto;
            border-radius: 12px;
        }

        .transactions-list::-webkit-scrollbar {
            width: 8px;
        }

        .transactions-list::-webkit-scrollbar-track {
            background: #2d3748;
            border-radius: 4px;
        }

        .transactions-list::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 4px;
        }

        .transactions-list::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }

        .transaction-item {
            padding: 16px;
            border-bottom: 1px solid #4a5568;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .transaction-item:hover {
            background: rgba(99, 179, 237, 0.1);
            transform: translateX(4px);
        }

        .transaction-type {
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .transaction-type.buy {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(72, 187, 120, 0.3);
        }

        .transaction-type.sell {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(245, 101, 101, 0.3);
        }

        .transaction-type.unknown {
            background: linear-gradient(135deg, #718096 0%, #4a5568 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(113, 128, 150, 0.3);
        }

        .wallet-address {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.85rem;
            color: #a0aec0;
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid #718096;
            font-weight: 500;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #a0aec0;
        }

        .spinner {
            border: 4px solid #4a5568;
            border-top: 4px solid #63b3ed;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            text-align: center;
            font-weight: 600;
            box-shadow: 0 4px 8px rgba(245, 101, 101, 0.3);
        }

        .timestamp {
            font-size: 0.75rem;
            color: #718096;
            font-weight: 500;
        }

        .system-info {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
            border-radius: 8px;
            border: 1px solid #718096;
        }

        .info-label {
            color: #a0aec0;
            font-weight: 600;
            font-size: 0.9rem;
            min-width: 180px;
        }

        .details-btn {
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
            border: 1px solid #718096;
            border-radius: 6px;
            padding: 6px 8px;
            cursor: pointer;
            color: #e2e8f0;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 70px;
            height: 28px;
        }

        .details-btn:hover {
            background: linear-gradient(135deg, #63b3ed 0%, #4299e1 100%);
            border-color: #63b3ed;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(99, 179, 237, 0.3);
        }

        .sol-suffix {
            font-size: 0.7rem;
            color: #a0aec0;
            margin-left: 4px;
            font-weight: 500;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            margin: 2% auto;
            padding: 24px;
            border-radius: 16px;
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid #4a5568;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #4a5568;
        }

        .modal-title {
            color: #e2e8f0;
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'IBM Plex Mono', monospace;
        }

        .close-btn {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            color: white;
            cursor: pointer;
            font-family: 'IBM Plex Mono', monospace;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: linear-gradient(135deg, #fc8181 0%, #f56565 100%);
            transform: translateY(-1px);
        }

        .json-viewer {
            background: #1a202c;
            border: 1px solid #4a5568;
            border-radius: 12px;
            padding: 20px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.6;
            color: #e2e8f0;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .json-viewer::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .json-viewer::-webkit-scrollbar-track {
            background: #2d3748;
            border-radius: 4px;
        }

        .json-viewer::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 4px;
        }

        .json-viewer::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }

        .json-key {
            color: #63b3ed;
            font-weight: 600;
        }

        .json-string {
            color: #68d391;
        }

        .json-number {
            color: #fbb6ce;
        }

        .json-boolean {
            color: #f6ad55;
        }

        .json-null {
            color: #a0aec0;
        }

        .numeric-value {
            font-family: 'IBM Plex Mono', monospace;
            font-weight: 600;
        }

        .price-arrow {
            display: inline-block;
            width: 12px;
            text-align: center;
            margin-right: 4px;
            font-size: 0.9em;
            font-weight: bold;
            opacity: 1;
            transition: opacity 1s ease-out;
            vertical-align: middle;
            line-height: 1;
        }

        .price-arrow.up {
            color: #68d391;
        }

        .price-arrow.down {
            color: #fc8181;
        }

        .price-arrow.fading {
            opacity: 0;
        }

        .positions-table td.price-column {
            width: 140px;
            min-width: 140px;
            max-width: 140px;
            white-space: nowrap;
            overflow: hidden;
        }

        .positions-table td.perf-column {
            width: 120px;
            min-width: 120px;
            max-width: 120px;
            white-space: nowrap;
            overflow: hidden;
        }

        @media (max-width: 1200px) {
            .container {
                padding: 16px;
            }
            
            .header h1 {
                font-size: 2.2rem;
                letter-spacing: 2px;
            }

            .summary-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 12px;
                text-align: center;
            }
            
            .header h1 {
                font-size: 1.8rem;
                letter-spacing: 1px;
            }
            
            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .positions-table {
                font-size: 0.85rem;
            }
            
            .positions-table th,
            .positions-table td {
                padding: 12px 8px;
            }

            .info-label {
                min-width: 140px;
                font-size: 0.8rem;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.8rem;
                letter-spacing: 1px;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
            }
        }

        .date-display {
            font-size: 0.85rem;
            color: #a0aec0;
            font-weight: 500;
            font-family: 'IBM Plex Mono', monospace;
        }

        .performance-visual-cell {
            padding: 8px 12px !important;
            vertical-align: middle;
        }

        .performance-bar-container {
            position: relative;
            width: 100%;
            height: 70px;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 20px;
        }

        .performance-bar-track {
            position: relative;
            width: 100%;
            height: 20px;
            background-color: #2d3748;
            border-radius: 4px;
            border: 1px solid #4a5568;
            overflow: visible;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }

        .performance-bar-center {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 100%;
            background-color: #e2e8f0;
            z-index: 3;
            box-shadow: 0 0 4px rgba(255,255,255,0.6);
        }

        .performance-bar-center-label {
            position: absolute;
            top: -35px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.85rem;
            color: #e2e8f0;
            white-space: nowrap;
            z-index: 4;
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
        }

        .performance-bar-fill {
            position: absolute;
            top: 0;
            height: 100%;
            transition: width 0.8s ease;
            z-index: 1;
            border-radius: 3px;
        }

        .performance-bar-fill.right {
            left: 50%;
            background: linear-gradient(90deg, #38a169, #48bb78, #68d391);
            border-radius: 0 3px 3px 0;
            box-shadow: 0 0 8px rgba(104, 211, 145, 0.4);
        }

        .performance-bar-fill.left {
            right: 50%;
            background: linear-gradient(270deg, #e53e3e, #fc8181, #f56565);
            border-radius: 3px 0 0 3px;
            box-shadow: 0 0 8px rgba(252, 129, 129, 0.4);
        }

        .performance-bar-label {
            position: absolute;
            top: -35px;
            font-size: 1.2rem;
            font-weight: 700;
            white-space: nowrap;
            z-index: 5;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
            text-align: center;
        }
        
                 .performance-value {
             font-size: 1.4rem;
             font-weight: 700;
         }
         
         .performance-bar-label.positive {
             color: #68d391;
         }
         
         .performance-bar-label.negative {
             color: #fc8181;
         }
         
         .position-card {
            background: #2d3748;
            border: 1px solid #4a5568;
            border-radius: 12px;
            padding: 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            overflow: hidden;
            margin-bottom: 32px;
            width: 100%;
            max-width: none;
            margin-left: 0;
            margin-right: 0;
            padding-left: 32px;
            padding-right: 32px;
            box-sizing: border-box;
        }
        
        /* Effet de survol supprimé selon demande utilisateur */
        
        .tp-toggle-btn {
            flex: 1;
            padding: 6px 12px;
            background: #374151;
            border: 1px solid #6b7280;
            color: #e5e7eb;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }
        
        .tp-toggle-btn:hover {
            background: #4b5563;
            border-color: #9ca3af;
            transform: translateY(-1px);
        }
        
        .tp-toggle-btn.active {
            background: #10b981;
            border-color: #10b981;
            color: white;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }
        
        .tp-toggle-btn.active:hover {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .performance-bar-marker {
            position: absolute;
            top: -2px;
            width: 1px;
            height: 24px;
            background-color: rgba(255, 255, 255, 0.4);
            z-index: 2;
        }

        .performance-bar-marker-label {
            position: absolute;
            top: 24px;
            font-size: 0.6rem;
            color: #a0aec0;
            white-space: nowrap;
            z-index: 4;
            transform: translateX(-50%);
            font-weight: 600;
        }

        /* Styles pour la ligne de performance sous les positions ouvertes */
        .performance-row {
            background: rgba(45, 55, 72, 0.3);
        }

        .performance-cell {
            padding: 12px 5px;
            border: none;
            border-top: none;
        }

        .performance-row .performance-bar-container {
            margin: 0 auto;
        }

        /* Supprimer la bordure inférieure de la ligne principale quand suivie d\'une barre de performance */
        .positions-table tbody tr:has(+ .performance-row) {
            border-bottom: none;
        }

        /* Alternative pour les navigateurs qui ne supportent pas :has() */
        .positions-table tbody tr + .performance-row {
            border-top: none;
        }

        /* Styles pour les barres de plus haut et plus bas */
        .performance-high-bar {
            position: absolute;
            top: -2px;
            width: 3px;
            height: 24px;
            background: linear-gradient(180deg, #68d391 0%, #48bb78 100%);
            border-radius: 1.5px;
            z-index: 6;
            box-shadow: 0 0 6px rgba(104, 211, 145, 0.6);
        }

        .performance-low-bar {
            position: absolute;
            top: -2px;
            width: 3px;
            height: 24px;
            background: linear-gradient(180deg, #fc8181 0%, #f56565 100%);
            border-radius: 1.5px;
            z-index: 6;
            box-shadow: 0 0 6px rgba(252, 129, 129, 0.6);
        }

        .performance-high-label {
            position: absolute;
            top: 26px;
            font-size: 0.55rem;
            color: #68d391;
            font-weight: 700;
            white-space: nowrap;
            z-index: 7;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
            transform: translateX(-50%);
            left: 50%;
        }

        .performance-low-label {
            position: absolute;
            top: 26px;
            font-size: 0.55rem;
            color: #fc8181;
            font-weight: 700;
            white-space: nowrap;
            z-index: 7;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
            transform: translateX(50%);
            right: 50%;
        }

        .action-buttons {
            display: flex;
            gap: 6px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        .sell-btn {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
            border: 1px solid #fc8181;
            border-radius: 6px;
            padding: 4px 8px;
            cursor: pointer;
            color: white;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.7rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 65px;
            height: 28px;
            white-space: nowrap;
        }

        .sell-btn:hover {
            background: linear-gradient(135deg, #fc8181 0%, #f56565 100%);
            border-color: #fc8181;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(245, 101, 101, 0.4);
        }

        .sell-btn:disabled {
            background: linear-gradient(135deg, #718096 0%, #4a5568 100%);
            border-color: #718096;
            cursor: not-allowed;
            opacity: 0.6;
            transform: none;
            box-shadow: none;
        }

        .sell-modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(8px);
        }

        .sell-modal-content {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            margin: 5% auto;
            padding: 30px;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            border: 2px solid #4a5568;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.8);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .sell-modal-header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #4a5568;
        }

        .sell-modal-title {
            color: #e2e8f0;
            font-size: 1.4rem;
            font-weight: 700;
            font-family: 'IBM Plex Mono', monospace;
            margin-bottom: 8px;
        }

        .sell-modal-subtitle {
            color: #a0aec0;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .sell-details {
            background: #1a202c;
            border: 1px solid #4a5568;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .sell-detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding: 8px 0;
        }

        .sell-detail-row:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-top: 1px solid #4a5568;
            padding-top: 12px;
            font-weight: 700;
        }

        .sell-detail-label {
            color: #a0aec0;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .sell-detail-value {
            color: #e2e8f0;
            font-size: 0.9rem;
            font-weight: 600;
            font-family: 'IBM Plex Mono', monospace;
        }

        .sell-detail-value.highlight {
            color: #68d391;
            font-size: 1rem;
        }

        .sell-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .confirm-sell-btn {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            color: white;
            cursor: pointer;
            font-family: 'IBM Plex Mono', monospace;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .confirm-sell-btn:hover {
            background: linear-gradient(135deg, #68d391 0%, #48bb78 100%);
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(72, 187, 120, 0.4);
        }

        .confirm-sell-btn:disabled {
            background: linear-gradient(135deg, #718096 0%, #4a5568 100%);
            cursor: not-allowed;
            opacity: 0.6;
            transform: none;
            box-shadow: none;
        }

        .cancel-sell-btn {
            background: linear-gradient(135deg, #718096 0%, #4a5568 100%);
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            color: white;
            cursor: pointer;
            font-family: 'IBM Plex Mono', monospace;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .cancel-sell-btn:hover {
            background: linear-gradient(135deg, #a0aec0 0%, #718096 100%);
            transform: translateY(-1px);
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #4a5568;
            border-radius: 50%;
            border-top-color: #68d391;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }

        /* @keyframes spin { // Déjà défini plus haut
            to { transform: rotate(360deg); }
        } */

        .error-message {
            background: linear-gradient(135deg, #fed7d7 0%, #feb2b2 100%);
            color: #742a2a;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            font-weight: 500;
            border: 1px solid #fc8181;
        }

        .success-message {
            background: linear-gradient(135deg, #c6f6d5 0%, #9ae6b4 100%);
            color: #22543d;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            font-weight: 500;
            border: 1px solid #68d391;
        }

        /* 🚨 STYLES POUR POSITIONS SUSPECTES */
        .suspicious-position {
            background: linear-gradient(135deg, rgba(255, 68, 68, 0.1) 0%, rgba(255, 136, 0, 0.1) 100%);
            border-left: 4px solid #ff4444 !important;
            animation: suspicious-pulse 2s ease-in-out infinite;
        }

        .suspicious-position:hover {
            background: linear-gradient(135deg, rgba(255, 68, 68, 0.2) 0%, rgba(255, 136, 0, 0.2) 100%);
        }

        @keyframes suspicious-pulse {
            0%, 100% {
                border-left-color: #ff4444;
                box-shadow: 0 0 5px rgba(255, 68, 68, 0.3);
            }
            50% {
                border-left-color: #ff8800;
                box-shadow: 0 0 15px rgba(255, 68, 68, 0.5);
            }
        }

        .suspicious-price {
            position: relative;
            animation: price-alert-blink 1.5s ease-in-out infinite;
        }

        @keyframes price-alert-blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .position-status {
        }
        
        /* ======================================================================================== */
        /* NOUVELLE INTERFACE CARDS - DESIGN PROFESSIONNEL */
        /* ======================================================================================== */
        
                 .section-header {
             margin: 0 0 20px 0;
             padding: 0;
             width: 100%;
         }
        
        .section-header h3 {
            color: #e2e8f0;
            font-size: 1.2rem;
            font-weight: 600;
            margin: 0;
            padding: 10px 0;
            border-bottom: 2px solid #4a5568;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .positions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
            width: 100%;
        }
        
        @media (max-width: 768px) {
            .positions-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }
        
        .position-card {
            background: #2d3748;
            border: 1px solid #4a5568;
            border-radius: 12px;
            padding: 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            overflow: hidden;
            margin-bottom: 32px;
            width: 100%;
            max-width: none;
            margin-left: 0;
            margin-right: 0;
            padding-left: 32px;
            padding-right: 32px;
            box-sizing: border-box;
        }
        
        .position-card:hover {
            border-color: #63b3ed;
            box-shadow: 0 6px 20px rgba(99, 179, 237, 0.15);
            transform: translateY(-2px);
        }
        
        .position-card.suspicious-position {
            border-color: #f56565;
            box-shadow: 0 6px 20px rgba(245, 101, 101, 0.2);
        }
        
        .card-header {
            padding: 24px;
            border-bottom: 1px solid #4a5568;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 24px;
            align-items: center;
        }
        
        .token-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .token-name {
            font-size: 1.4rem;
            font-weight: 700;
            color: #e2e8f0;
            margin: 0;
            margin-bottom: 8px;
        }
        
        .token-details {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .investment-info {
            font-size: 0.9rem;
            color: #a0aec0;
            margin-top: 4px;
        }
        
        .performance-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            text-align: center;
        }
        
        .current-price {
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .current-price-value {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .current-price-value.price-up {
            color: #10b981;
        }
        
        .current-price-value.price-down {
            color: #ef4444;
        }
        
        .price-loading {
            color: #a0aec0;
            font-style: italic;
        }
        
        .performance-display {
            font-size: 1.4rem;
            font-weight: 700;
        }
        
        .sell-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: center;
        }
        
        .sell-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            width: 180px;
        }
        
        .sell-btn {
            padding: 10px 8px;
            border: 1px solid;
            border-radius: 6px;
            background: transparent;
            color: white;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            min-height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .sell-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        .sell-25 {
            border-color: #f6ad55;
            color: #f6ad55;
        }
        
        .sell-25:hover {
            background: #f6ad55;
            color: #1a202c;
        }
        
        .sell-25-fast {
            border-color: #00d4aa;
            color: #00d4aa;
            background: linear-gradient(45deg, rgba(0, 212, 170, 0.1), rgba(0, 212, 170, 0.2));
            position: relative;
            overflow: hidden;
            animation: pulse-fast 2s ease-in-out infinite;
        }
        
        .sell-25-fast:hover {
            background: #00d4aa;
            color: #1a202c;
            box-shadow: 0 0 15px rgba(0, 212, 170, 0.5);
            transform: translateY(-2px);
        }
        
        .sell-25-fast::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transform: rotate(45deg);
            animation: shine-fast 3s linear infinite;
        }
        
        @keyframes pulse-fast {
            0%, 100% { box-shadow: 0 0 5px rgba(0, 212, 170, 0.3); }
            50% { box-shadow: 0 0 20px rgba(0, 212, 170, 0.6); }
        }
        
        @keyframes shine-fast {
            0% { transform: rotate(45deg) translateX(-200%); }
            100% { transform: rotate(45deg) translateX(200%); }
        }
        
        .sell-50 {
            border-color: #63b3ed;
            color: #63b3ed;
        }
        
        .sell-50:hover {
            background: #63b3ed;
            color: #1a202c;
        }
        
        .sell-75 {
            border-color: #9f7aea;
            color: #9f7aea;
        }
        
        .sell-75:hover {
            background: #9f7aea;
            color: #1a202c;
        }
        
        .sell-100 {
            border-color: #f56565;
            color: #f56565;
        }
        
        .sell-100:hover {
            background: #f56565;
            color: #1a202c;
        }
        
        .sell-timer {
            background: rgba(99, 179, 237, 0.1);
            border: 1px solid #63b3ed;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 0.8rem;
            color: #63b3ed;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            animation: pulse-timer 1s ease-in-out infinite;
        }
        
        .sell-25-fast-container {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        
        .fast-timer {
            background: rgba(255, 193, 7, 0.15);
            border: 1px solid #ffc107;
            border-radius: 4px;
            padding: 3px 8px;
            font-size: 0.7rem;
            color: #ffc107;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 4px;
            animation: pulse-fast-timer 0.8s ease-in-out infinite;
            min-width: 65px;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(255, 193, 7, 0.2);
        }
        
        @keyframes pulse-fast-timer {
            0%, 100% { 
                opacity: 1; 
                transform: scale(1);
                box-shadow: 0 2px 4px rgba(255, 193, 7, 0.2);
            }
            50% { 
                opacity: 0.8; 
                transform: scale(1.05);
                box-shadow: 0 4px 8px rgba(255, 193, 7, 0.4);
            }
        }
        
        .fast-timer-value {
            font-family: 'IBM Plex Mono', monospace;
            letter-spacing: 0.5px;
        }
        
        @keyframes pulse-timer {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .card-performance {
            padding: 20px 24px;
        }
        
        .enhanced-performance-bar {
            width: 100%;
        }
        
        .performance-bar-track {
            position: relative;
            height: 20px;
            background-color: #2d3748;
            border-radius: 4px;
            border: 1px solid #4a5568;
            overflow: visible;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 15px;
        }
        
        .performance-bar-center {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 100%;
            background-color: #e2e8f0;
            z-index: 3;
            box-shadow: 0 0 4px rgba(255,255,255,0.6);
        }
        
        .performance-bar-center-label {
            position: absolute;
            top: -35px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8rem;
            color: #e2e8f0;
            white-space: nowrap;
            z-index: 4;
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
        }
        
        .performance-bar-fill {
            position: absolute;
            top: 0;
            height: 100%;
            transition: width 0.8s ease;
            z-index: 1;
            border-radius: 3px;
        }
        
        .performance-bar-fill.right {
            left: 50%;
            background: linear-gradient(90deg, #38a169, #48bb78, #68d391);
            border-radius: 0 3px 3px 0;
            box-shadow: 0 0 8px rgba(104, 211, 145, 0.4);
        }
        
        .performance-bar-fill.left {
            right: 50%;
            background: linear-gradient(270deg, #e53e3e, #fc8181, #f56565);
            border-radius: 3px 0 0 3px;
            box-shadow: 0 0 8px rgba(252, 129, 129, 0.4);
        }
        
        .performance-bar-label {
            position: absolute;
            top: -35px;
            font-size: 1.2rem;
            font-weight: 700;
            white-space: nowrap;
            z-index: 5;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
            text-align: center;
        }
        
        .performance-value {
            font-size: 1.4rem;
            font-weight: 700;
        }
        
        .performance-bar-marker {
            position: absolute;
            top: -2px;
            width: 1px;
            height: 24px;
            background-color: rgba(255, 255, 255, 0.4);
            z-index: 2;
        }
        
        .performance-bar-marker-label {
            position: absolute;
            top: 24px;
            font-size: 0.6rem;
            color: #a0aec0;
            white-space: nowrap;
            z-index: 4;
            transform: translateX(-50%);
            font-weight: 600;
        }
        
        /* Marqueur spécial Take Profit +10% */
        .performance-bar-marker.tp-marker {
            width: 3px;
            height: 28px;
            background: linear-gradient(180deg, #10b981, #059669);
            border-radius: 1.5px;
            box-shadow: 0 0 12px rgba(16, 185, 129, 0.8);
            animation: tp-marker-pulse 2s ease-in-out infinite;
        }
        
        .performance-bar-marker-label.tp-label {
            color: #10b981;
            font-weight: 700;
            font-size: 0.65rem;
            background: rgba(16, 185, 129, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid rgba(16, 185, 129, 0.3);
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
        }
        
        @keyframes tp-marker-pulse {
            0%, 100% { 
                box-shadow: 0 0 12px rgba(16, 185, 129, 0.6);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 0 20px rgba(16, 185, 129, 1);
                transform: scale(1.1);
            }
        }
        
        /* Take Profit Controls */
        .take-profit-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            padding: 8px;
            background: rgba(15, 20, 25, 0.4);
            border-radius: 8px;
            border: 1px solid rgba(75, 85, 99, 0.3);
        }
        
        .tp-toggle-btn {
            flex: 1;
            padding: 6px 12px;
            background: #374151;
            border: 1px solid #6b7280;
            color: #e5e7eb;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }
        
        .tp-toggle-btn:hover {
            background: #4b5563;
            border-color: #9ca3af;
            transform: translateY(-1px);
        }
        
        .tp-toggle-btn.active {
            background: #10b981;
            border-color: #10b981;
            color: white;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }
        
        .tp-toggle-btn.active:hover {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }
        
        .tp-status {
            font-size: 11px;
            font-weight: 600;
            color: #6b7280;
            white-space: nowrap;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(55, 65, 81, 0.5);
            border: 1px solid rgba(75, 85, 99, 0.3);
        }
        
                 /* Styles pour marqueurs Take Profit étagés et Stop Loss */
         .tp-marker-simple, .sl-marker-simple {
             position: absolute;
             top: 0;
             z-index: 5;
             transform: translateX(-50%);
         }
         
         .tp-line {
             width: 2px;
             height: 22px;
             background: linear-gradient(180deg, #10b981, #059669);
             border-radius: 1px;
             margin: 0 auto 2px auto;
             box-shadow: 0 0 4px rgba(16, 185, 129, 0.4);
         }
         
         .sl-line {
             width: 3px;
             height: 24px;
             background: linear-gradient(180deg, #dc2626, #b91c1c);
             border-radius: 1.5px;
             margin: 0 auto 2px auto;
             box-shadow: 0 0 6px rgba(220, 38, 38, 0.6);
             animation: sl-pulse 2s ease-in-out infinite;
         }
         
         @keyframes sl-pulse {
             0%, 100% { 
                 box-shadow: 0 0 6px rgba(220, 38, 38, 0.6);
                 transform: scale(1);
             }
             50% { 
                 box-shadow: 0 0 12px rgba(220, 38, 38, 0.8);
                 transform: scale(1.1);
             }
         }
         
         .tp-label-simple {
             font-size: 9px;
             font-weight: 700;
             color: #10b981;
             text-align: center;
             white-space: nowrap;
             text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
             background: rgba(0, 0, 0, 0.7);
             padding: 2px 4px;
             border-radius: 3px;
             border: 1px solid rgba(16, 185, 129, 0.3);
         }
         
         .sl-label-simple {
             font-size: 9px;
             font-weight: 700;
             color: #dc2626;
             text-align: center;
             white-space: nowrap;
             text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
             background: rgba(0, 0, 0, 0.7);
             padding: 2px 4px;
             border-radius: 3px;
             border: 1px solid rgba(220, 38, 38, 0.4);
         }
         
         /* Nouveaux styles pour les labels TP/SL améliorés */
         .tp-label-enhanced, .sl-label-enhanced {
             display: flex;
             flex-direction: column;
             align-items: center;
             gap: 2px;
             text-align: center;
             white-space: nowrap;
             text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
             background: rgba(0, 0, 0, 0.8);
             padding: 4px 6px;
             border-radius: 4px;
             border: 1px solid rgba(74, 85, 104, 0.4);
         }
         
         .tp-label-name, .sl-label-name {
             font-size: 13px;
             font-weight: 800;
             letter-spacing: 0.5px;
         }
         
         .tp-label-percent, .sl-label-percent {
             font-size: 11px;
             font-weight: 600;
             font-family: 'IBM Plex Mono', monospace;
         }
         
                         /* Couleurs uniformes pour tous les Take Profit */
         .tp-label-enhanced.tp1 { color: #00ff88; border-color: rgba(0, 255, 136, 0.4); }
         .tp-label-enhanced.tp2 { color: #00ff88; border-color: rgba(0, 255, 136, 0.4); }
         .tp-label-enhanced.tp3 { color: #00ff88; border-color: rgba(0, 255, 136, 0.4); }
         .tp-label-enhanced.tp4 { color: #00ff88; border-color: rgba(0, 255, 136, 0.4); }
         
         .sl-label-enhanced {
             color: #fc8181;
             border-color: rgba(252, 129, 129, 0.4);
         }
         
         /* Design moderne de la barre de performance */
         .performance-bar-modern {
             position: relative;
             width: 100%;
             height: 24px;
             background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
             border-radius: 12px;
             border: 1px solid #4a5568;
             overflow: hidden;
             box-shadow: 
                 inset 0 2px 4px rgba(0,0,0,0.4),
                 0 2px 8px rgba(0,0,0,0.2);
         }
         
         .performance-bar-glow {
             position: absolute;
             top: 0;
             height: 100%;
             border-radius: 12px;
             transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
             z-index: 1;
         }
         
         .performance-bar-glow.positive {
             background: linear-gradient(135deg, #00ff88 0%, #00d4ff 50%, #10b981 100%);
             box-shadow: 0 0 20px rgba(0, 255, 136, 0.4);
             left: 33.33%;
         }
         
         .performance-bar-glow.negative {
             background: linear-gradient(135deg, #ff4757 0%, #ff6b7a 50%, #ef4444 100%);
             box-shadow: 0 0 20px rgba(255, 71, 87, 0.4);
             right: 66.67%;
         }
         
         .performance-bar-center-new {
             position: absolute;
             top: 0;
             left: 33.33%;
             width: 3px;
             height: 100%;
             background: linear-gradient(180deg, #ffffff 0%, #e2e8f0 100%);
             z-index: 3;
             transform: translateX(-50%);
             border-radius: 1px;
             box-shadow: 0 0 8px rgba(255, 255, 255, 0.6);
         }
         
         .performance-bar-center-label-new {
             position: absolute;
             bottom: -22px;
             left: 33.33%;
             transform: translateX(-50%);
             font-size: 10px;
             color: #ffffff;
             font-weight: 700;
             background: rgba(0, 0, 0, 0.8);
             padding: 3px 6px;
             border-radius: 4px;
             border: 1px solid rgba(255, 255, 255, 0.3);
             text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
         }
         
         .performance-scale-labels {
             display: flex;
             justify-content: space-between;
             margin-top: 12px;
             padding: 0 8px;
         }
         
         .scale-label-left {
             font-size: 11px;
             color: #ff4757;
             font-weight: 700;
             text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
         }
         
         .scale-label-right {
             font-size: 11px;
             color: #00ff88;
             font-weight: 700;
             text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
         }
         
         .performance-bar-overlay {
             position: absolute;
             top: 0;
             left: 0;
             width: 100%;
             height: 100%;
             background: linear-gradient(45deg, transparent 48%, rgba(255,255,255,0.1) 50%, transparent 52%);
             animation: shimmer 3s linear infinite;
         }
         
         @keyframes shimmer {
             0% { transform: translateX(-100%); }
             100% { transform: translateX(100%); }
         }
        
                 /* Styles pour la nouvelle structure simplifiée de carte */
         .card-section-top {
             padding: 20px 24px 16px 24px;
             border-bottom: 1px solid rgba(74, 85, 104, 0.3);
             display: flex;
             justify-content: space-between;
             align-items: center;
         }
         
         .token-name-main {
             font-size: 1.5rem;
             font-weight: 700;
             color: #e2e8f0;
             font-family: 'IBM Plex Mono', monospace;
         }
         
         .current-price-main {
             font-size: 1.1rem;
             font-weight: 600;
             color: #a0aec0;
             display: flex;
             align-items: center;
             gap: 6px;
         }
         
         .card-performance-main {
             padding: 24px;
             background: rgba(15, 20, 25, 0.2);
             border-bottom: 1px solid rgba(74, 85, 104, 0.3);
         }
         
         .performance-controls {
             display: flex;
             justify-content: center;
             align-items: center;
             gap: 16px;
             margin-top: 16px;
             padding: 12px;
             background: rgba(0, 0, 0, 0.2);
             border-radius: 8px;
             border: 1px solid rgba(74, 85, 104, 0.2);
         }
         
         .sell-25-fast {
             background: linear-gradient(135deg, #00d4aa 0%, #00b894 100%);
             border: 1px solid #00d4aa;
             color: white;
             padding: 8px 16px;
             border-radius: 6px;
             font-weight: 700;
             font-size: 0.9rem;
             cursor: pointer;
             transition: all 0.3s ease;
             position: relative;
             overflow: hidden;
             animation: pulse-fast-sell 2s ease-in-out infinite;
         }
         
         .sell-25-fast:hover {
             background: linear-gradient(135deg, #00e6c2 0%, #00d4aa 100%);
             transform: translateY(-2px);
             box-shadow: 0 6px 16px rgba(0, 212, 170, 0.4);
         }
         
         @keyframes pulse-fast-sell {
             0%, 100% { box-shadow: 0 0 8px rgba(0, 212, 170, 0.3); }
             50% { box-shadow: 0 0 16px rgba(0, 212, 170, 0.6); }
         }
         
         .card-section-bottom {
             padding: 16px 24px;
             display: flex;
             flex-direction: column;
             gap: 12px;
             background: rgba(0, 0, 0, 0.1);
         }
         
         /* ============================================================================ */
         /* NOUVEAU DESIGN MODERNE DES CARTES DE POSITION                             */
         /* ============================================================================ */
         
         .position-card-new {
             background: linear-gradient(145deg, #1a202c 0%, #2d3748 100%);
             border: 1px solid #4a5568;
             border-radius: 16px;
             overflow: hidden;
             box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
             transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
             margin-bottom: 24px;
             backdrop-filter: blur(10px);
         }
         
         /* Effet de survol supprimé selon demande utilisateur */
         
         .card-header-new {
             background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
             padding: 16px 24px;
             border-bottom: 1px solid rgba(74, 85, 104, 0.3);
             display: flex;
             justify-content: space-between;
             align-items: center;
         }
         
         .token-title-section {
             display: flex;
             align-items: center;
             gap: 16px;
         }
         
         .current-price-live {
             font-size: 1.1rem;
             font-weight: 600;
             color: #4299e1;
             font-family: 'IBM Plex Mono', monospace;
         }
         
         .price-display-container {
             display: flex;
             align-items: center;
             gap: 8px;
         }
         
         .price-arrow {
             font-size: 14px;
             min-width: 16px;
             text-align: center;
             transition: all 0.3s ease;
         }
         
         .price-arrow.price-up {
             color: #10b981;
             animation: price-pulse-up 0.6s ease-out;
         }
         
         .price-arrow.price-down {
             color: #ef4444;
             animation: price-pulse-down 0.6s ease-out;
         }
         
         .price-value {
             font-family: 'IBM Plex Mono', monospace;
             font-weight: 600;
             font-size: 1.2rem;
             color: #ffffff;
         }
         
         @keyframes price-pulse-up {
             0% { transform: scale(1); }
             50% { transform: scale(1.2); color: #34d399; }
             100% { transform: scale(1); }
         }
         
         @keyframes price-pulse-down {
             0% { transform: scale(1); }
             50% { transform: scale(1.2); color: #f87171; }
             100% { transform: scale(1); }
         }
         
         .header-controls {
             display: flex;
             align-items: center;
             gap: 16px;
         }
         
         .details-container-header {
             display: flex;
             flex-direction: column;
             align-items: center;
             gap: 8px;
         }
         
         .details-btn-header {
             background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
             border: 1px solid #6b7280;
             color: #e5e7eb;
             padding: 8px 16px;
             border-radius: 8px;
             font-size: 0.8rem;
             font-weight: 600;
             cursor: pointer;
             transition: all 0.3s ease;
             display: flex;
             align-items: center;
             gap: 6px;
             min-width: 80px;
             justify-content: center;
         }
         
         .details-btn-header:hover {
             background: linear-gradient(135deg, #63b3ed 0%, #4299e1 100%);
             border-color: #63b3ed;
             color: white;
             transform: translateY(-2px);
             box-shadow: 0 4px 16px rgba(99, 179, 237, 0.3);
         }
         
         .details-icon-new {
             font-size: 1rem;
         }
         
         .details-text-new {
             font-family: 'IBM Plex Mono', monospace;
         }
         
         .sell-container-header, .tp-container-header {
             display: flex;
             flex-direction: column;
             align-items: center;
             gap: 4px;
         }
         
         .sell-btn-header {
             background: linear-gradient(135deg, #00d4aa 0%, #00b894 100%);
             border: none;
             color: white;
             padding: 8px 16px;
             border-radius: 8px;
             font-weight: 700;
             font-size: 0.9rem;
             cursor: pointer;
             transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
             box-shadow: 0 4px 16px rgba(0, 212, 170, 0.3);
             display: flex;
             align-items: center;
             gap: 6px;
             min-width: 80px;
             justify-content: center;
         }
         
         .sell-btn-header:hover {
             transform: translateY(-2px);
             box-shadow: 0 8px 24px rgba(0, 212, 170, 0.4);
             background: linear-gradient(135deg, #00e6c2 0%, #00d4aa 100%);
         }
         
         /* Container pour aligner les boutons 25% et Close */
         .sell-container-header {
             display: flex;
             flex-direction: row;
             align-items: center;
             gap: 8px;
         }
         
         /* Bouton Close spécifique - Rouge pour fermeture complète avec même taille que 25% */
         .sell-100-close {
             background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
             border: none !important;
             color: white !important;
             padding: 8px 16px !important;
             border-radius: 8px !important;
             font-weight: 700 !important;
             font-size: 0.9rem !important;
             cursor: pointer !important;
             transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
             box-shadow: 0 4px 16px rgba(239, 68, 68, 0.3) !important;
             display: flex !important;
             align-items: center !important;
             gap: 6px !important;
             min-width: 80px !important;
             justify-content: center !important;
         }
         
         .sell-100-close:hover {
             background: linear-gradient(135deg, #f87171 0%, #ef4444 100%) !important;
             box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4) !important;
             transform: translateY(-2px) !important;
         }
         
         .tp-btn-header {
             background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
             border: 1px solid #6b7280;
             color: #e5e7eb;
             padding: 8px 16px;
             border-radius: 8px;
             font-size: 0.8rem;
             font-weight: 600;
             cursor: pointer;
             transition: all 0.3s ease;
             display: flex;
             align-items: center;
             gap: 6px;
             min-width: 80px;
             justify-content: center;
         }
         
         .tp-btn-header:hover {
             background: linear-gradient(135deg, #63b3ed 0%, #4299e1 100%);
             border-color: #63b3ed;
             color: white;
             transform: translateY(-2px);
             box-shadow: 0 4px 16px rgba(99, 179, 237, 0.3);
         }
         
         .tp-btn-header.active {
             background: linear-gradient(135deg, #10b981 0%, #059669 100%);
             border-color: #10b981;
             color: white;
             box-shadow: 0 4px 16px rgba(16, 185, 129, 0.3);
         }
         
         .tp-btn-header.active:hover {
             background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
             transform: translateY(-2px);
             box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
         }
         
         .tp-status-header {
             font-size: 10px;
             color: #a0aec0;
             font-weight: 600;
             text-align: center;
         }
         
         .tp-btn-footer {
             background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
             border: 1px solid #6b7280;
             color: #e5e7eb;
             padding: 8px 16px;
             border-radius: 8px;
             font-size: 0.8rem;
             font-weight: 600;
             cursor: pointer;
             transition: all 0.3s ease;
             display: flex;
             align-items: center;
             gap: 6px;
             min-width: 80px;
             justify-content: center;
         }
         
         .tp-btn-footer:hover {
             background: linear-gradient(135deg, #63b3ed 0%, #4299e1 100%);
             border-color: #63b3ed;
             color: white;
             transform: translateY(-2px);
             box-shadow: 0 4px 16px rgba(99, 179, 237, 0.3);
         }
         
         .tp-btn-footer.active {
             background: linear-gradient(135deg, #10b981 0%, #059669 100%);
             border-color: #10b981;
             color: white;
             box-shadow: 0 4px 16px rgba(16, 185, 129, 0.3);
         }
         
         .tp-btn-footer.active:hover {
             background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
             transform: translateY(-2px);
             box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
         }
         
         .token-name-new {
             font-size: 1.8rem;
             font-weight: 700;
             color: #e2e8f0;
             font-family: 'IBM Plex Mono', monospace;
             letter-spacing: 1px;
             text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
         }
         
         .dex-badge-new {
             display: inline-flex;
             align-items: center;
             background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
             color: white;
             padding: 6px 16px;
             border-radius: 20px;
             font-size: 0.75rem;
             font-weight: 600;
             text-transform: uppercase;
             letter-spacing: 0.5px;
             box-shadow: 0 4px 12px rgba(66, 153, 225, 0.3);
             border: 1px solid rgba(99, 179, 237, 0.5);
         }
         
         .price-section-new {
             text-align: right;
             font-size: 1.2rem;
             font-weight: 600;
             color: #a0aec0;
         }
         
         .card-main-content {
             display: flex;
             gap: 20px;
             padding: 20px 24px 24px 24px; /* Padding bottom étendu puisque plus de footer */
             min-height: 180px; /* Hauteur minimale pour que l'activité ait de l'espace */
         }
         
         .info-column-left {
             flex: 0 0 280px; /* Largeur augmentée pour plus d'infos */
             display: grid;
             grid-template-columns: 1fr 1fr; /* Deux colonnes égales pour meilleure lisibilité */
             gap: 12px;
             row-gap: 8px; /* Espacement vertical plus petit */
         }
         
         .info-item-vertical {
             display: flex;
             align-items: center;
             gap: 8px;
         }
         
         .info-icon-vertical {
             width: 24px;
             height: 24px;
             display: flex;
             align-items: center;
             justify-content: center;
             background: linear-gradient(135deg, #4299e1, #3182ce);
             border-radius: 50%;
             font-size: 12px;
             flex-shrink: 0;
         }
         
         .info-text-vertical {
             display: flex;
             flex-direction: column;
             gap: 2px;
         }
         
         .info-label-vertical {
             font-size: 12px;
             color: #a0aec0;
             font-weight: 500;
             text-transform: uppercase;
             letter-spacing: 0.5px;
         }
         
         .info-value-vertical {
             font-size: 16px;
             color: #e2e8f0;
             font-weight: 700;
             font-family: 'IBM Plex Mono', monospace;
         }
         
         .performance-section-middle {
             flex: 1; /* Prend l'espace central */
             display: flex;
             flex-direction: column;
             justify-content: center;
             gap: 16px;
             margin: 35px 20px 0 20px; /* Margin-top encore augmenté pour descendre plus le bloc */
         }
         
         .tp-control-center {
             display: flex;
             justify-content: center;
             margin-top: 50px;
         }
         
         .tp-btn-center {
             background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
             border: 1px solid #6b7280;
             color: #e5e7eb;
             padding: 10px 20px;
             border-radius: 10px;
             font-size: 0.9rem;
             font-weight: 600;
             cursor: pointer;
             transition: all 0.3s ease;
             display: flex;
             align-items: center;
             gap: 8px;
             min-width: 100px;
             justify-content: center;
         }
         
         .tp-btn-center:hover {
             background: linear-gradient(135deg, #63b3ed 0%, #4299e1 100%);
             border-color: #63b3ed;
             color: white;
             transform: translateY(-2px);
             box-shadow: 0 4px 16px rgba(99, 179, 237, 0.3);
         }
         
         .tp-btn-center.active {
             background: linear-gradient(135deg, #10b981 0%, #059669 100%);
             border-color: #10b981;
             color: white;
             box-shadow: 0 4px 16px rgba(16, 185, 129, 0.3);
         }
         
         .tp-btn-center.active:hover {
             background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
             transform: translateY(-2px);
             box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
         }
         
         .tp-icon-center {
             font-size: 1rem;
         }
         
         .tp-text-center {
             font-family: 'IBM Plex Mono', monospace;
         }
         
         .activity-column-right {
             flex: 0 0 380px; /* Largeur encore augmentée pour une ligne */
             background: rgba(0, 0, 0, 0.2);
             border-radius: 12px;
             padding: 8px 16px; /* Padding top encore plus réduit */
             border: 1px solid rgba(74, 85, 104, 0.3);
             display: flex;
             flex-direction: column;
             /* height: fit-content; SUPPRIMÉ - permet à la section de s'étendre */
             min-height: 140px; /* Hauteur minimum pour l'activité */
         }
         
         .activity-header {
             font-size: 14px;
             font-weight: 600;
             color: #4299e1;
             margin-bottom: 4px; /* Margin encore plus réduit */
             text-transform: uppercase;
             letter-spacing: 0.5px;
             flex-shrink: 0;
         }
         
         .activity-entry {
             display: flex;
             flex-direction: column;
             gap: 0px; /* Espacement au minimum entre lignes */
             flex-grow: 1;
             overflow-y: auto;
             /* max-height: 200px; SUPPRIMÉ - laisse l'activité prendre tout l'espace */
         }
         
         .activity-line {
             font-size: 12.5px; /* Taille légèrement réduite pour optimiser */
             color: #e2e8f0;
             font-weight: 600;
             line-height: 1.2; /* Line height réduite pour plus de compacité */
             word-wrap: break-word;
             font-family: 'IBM Plex Mono', monospace;
             padding: 1px 0; /* Padding encore plus minimal */
         }
         
         .performance-controls-new {
             display: flex;
             justify-content: center;
             align-items: center;
             gap: 24px;
             margin-top: 20px;
             padding: 16px;
             background: linear-gradient(135deg, rgba(0, 0, 0, 0.2) 0%, rgba(0, 0, 0, 0.1) 100%);
             border-radius: 12px;
             border: 1px solid rgba(74, 85, 104, 0.2);
         }
         
         .sell-container-new {
             display: flex;
             flex-direction: column;
             align-items: center;
             gap: 8px;
         }
         
         .sell-btn-new {
             background: linear-gradient(135deg, #00d4aa 0%, #00b894 100%);
             border: none;
             color: white;
             padding: 12px 20px;
             border-radius: 12px;
             font-weight: 700;
             font-size: 1rem;
             cursor: pointer;
             transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
             box-shadow: 0 4px 16px rgba(0, 212, 170, 0.3);
             display: flex;
             align-items: center;
             gap: 8px;
             min-width: 100px;
             justify-content: center;
         }
         
         .sell-btn-new:hover {
             transform: translateY(-2px);
             box-shadow: 0 8px 24px rgba(0, 212, 170, 0.4);
             background: linear-gradient(135deg, #00e6c2 0%, #00d4aa 100%);
         }
         
         .sell-icon-new {
             font-size: 1.1rem;
         }
         
         .sell-text-new {
             font-family: 'IBM Plex Mono', monospace;
         }
         
         .fast-timer-new {
             background: linear-gradient(135deg, rgba(255, 193, 7, 0.2) 0%, rgba(255, 193, 7, 0.1) 100%);
             border: 1px solid #ffc107;
             border-radius: 8px;
             padding: 6px 12px;
             font-size: 0.8rem;
             color: #ffc107;
             font-weight: 700;
             display: flex;
             align-items: center;
             gap: 6px;
             box-shadow: 0 2px 8px rgba(255, 193, 7, 0.2);
             animation: pulse-timer-new 1s ease-in-out infinite;
         }
         
         @keyframes pulse-timer-new {
             0%, 100% { 
                 opacity: 1; 
                 transform: scale(1);
             }
             50% { 
                 opacity: 0.8; 
                 transform: scale(1.05);
             }
         }
         
         .timer-icon-new {
             font-size: 1rem;
         }
         
         .tp-container-new {
             display: flex;
             flex-direction: column;
             align-items: center;
             gap: 8px;
         }
         
         .tp-btn-new {
             background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
             border: 1px solid #6b7280;
             color: #e5e7eb;
             padding: 12px 20px;
             border-radius: 12px;
             font-size: 0.9rem;
             font-weight: 600;
             cursor: pointer;
             transition: all 0.3s ease;
             display: flex;
             align-items: center;
             gap: 8px;
             min-width: 100px;
             justify-content: center;
         }
         
         .tp-btn-new:hover {
             background: linear-gradient(135deg, #63b3ed 0%, #4299e1 100%);
             border-color: #63b3ed;
             color: white;
             transform: translateY(-2px);
             box-shadow: 0 4px 16px rgba(99, 179, 237, 0.3);
         }
         
         .tp-btn-new.active {
             background: linear-gradient(135deg, #10b981 0%, #059669 100%);
             border-color: #10b981;
             color: white;
             box-shadow: 0 4px 16px rgba(16, 185, 129, 0.3);
         }
         
         .tp-btn-new.active:hover {
             background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
             transform: translateY(-2px);
             box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
         }
         
         .tp-icon-new {
             font-size: 1rem;
         }
         
         .tp-text-new {
             font-family: 'IBM Plex Mono', monospace;
         }
         
         .tp-status-new {
             font-size: 0.75rem;
             font-weight: 600;
             color: #a0aec0;
             background: rgba(74, 85, 104, 0.3);
             padding: 4px 8px;
             border-radius: 6px;
             border: 1px solid rgba(113, 128, 150, 0.3);
         }
         
         /* Footer supprimé selon demande utilisateur */
         
         .price-info-new {
             display: flex;
             flex-direction: column;
             gap: 4px;
         }
         
         .price-label-new {
             font-size: 0.8rem;
             color: #a0aec0;
             font-weight: 500;
         }
         
         .price-value-new {
             font-size: 0.9rem;
             color: #e2e8f0;
             font-weight: 600;
             font-family: 'IBM Plex Mono', monospace;
         }
         
         /* CSS action-buttons-new et action-btn-new supprimés car footer supprimé */
         
         /* CSS action-btn-new:hover supprimé car footer supprimé */
         
         /* CSS btn-icon-new et btn-text-new supprimés car footer supprimé */
         
         /* Responsive design pour les nouvelles cartes */
         @media (max-width: 768px) {
             .details-grid-new {
                 grid-template-columns: 1fr;
                 gap: 12px;
             }
             
             .performance-controls-new {
                 flex-direction: column;
                 gap: 16px;
             }
             
             .card-footer-new {
                 flex-direction: column;
                 gap: 16px;
                 align-items: flex-start;
             }
             
             .action-buttons-new {
                 width: 100%;
                 justify-content: center;
             }
         }
         
         .footer-buttons {
             display: flex;
             gap: 8px;
             align-items: center;
         }
         
         .log-btn {
             background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
             border: 1px solid #718096;
             border-radius: 6px;
             padding: 6px 12px;
             cursor: pointer;
             color: #e2e8f0;
             font-family: 'IBM Plex Mono', monospace;
             font-size: 0.8rem;
             font-weight: 600;
             transition: all 0.3s ease;
             display: flex;
             align-items: center;
             justify-content: center;
             min-width: 70px;
             height: 28px;
         }
         
         .log-btn:hover {
             background: linear-gradient(135deg, #63b3ed 0%, #4299e1 100%);
             border-color: #63b3ed;
             transform: translateY(-1px);
             box-shadow: 0 4px 8px rgba(99, 179, 237, 0.3);
         }
         
         .performance-bar-loading {
             width: 100%;
             height: 100%;
             background: #4a5568;
             border-radius: 12px;
             overflow: hidden;
             position: relative;
         }
        
        .loading-shimmer {
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            animation: shimmer 1.5s infinite;
        }
        
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .performance-indicators {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .performance-value {
            font-size: 1.4rem;
            font-weight: 700;
        }
        
        .performance-value.positive {
            color: #10b981;
        }
        
        .performance-value.negative {
            color: #ef4444;
        }
        
        .performance-pnl {
            font-size: 1rem;
            color: #a0aec0;
            font-weight: 600;
        }
        
        .card-footer {
            padding: 18px 24px;
            border-top: 1px solid #4a5568;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.1);
        }
        
        .price-details {
            display: flex;
            gap: 8px;
            align-items: center;
            font-size: 0.9rem;
            color: #a0aec0;
        }
        
        .details-btn {
            background: linear-gradient(135deg, #4a5568, #2d3748);
            color: #e2e8f0;
            border: 1px solid #4a5568;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .details-btn:hover {
            background: linear-gradient(135deg, #63b3ed, #4299e1);
            border-color: #63b3ed;
            color: white;
        }

        .log-btn {
            background: linear-gradient(135deg, #1a365d, #2b6cb0);
            border: 1px solid #2b77ad;
            color: #90cdf4;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'IBM Plex Mono', monospace;
        }

        .log-btn:hover {
            background: linear-gradient(135deg, #2b77ad, #3182ce);
            border-color: #90cdf4;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(43, 119, 173, 0.3);
        }

        .log-btn.small {
            padding: 4px 8px;
            font-size: 0.7rem;
            min-width: 32px;
        }

        .footer-buttons {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .table-buttons {
            display: flex;
            align-items: center;
            gap: 6px;
            justify-content: center;
        }
        
        /* ======================================================================================== */
        /* TABLEAU COMPACT POUR POSITIONS FERMÉES */
        /* ======================================================================================== */
        
        .closed-positions-table {
            width: 100%;
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            border-radius: 8px;
            border-collapse: collapse;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .closed-positions-table thead {
            background: linear-gradient(135deg, #4a5568, #2d3748);
        }
        
        .closed-positions-table th {
            padding: 12px 16px;
            color: #e2e8f0;
            font-weight: 600;
            text-align: center;
            border-bottom: 1px solid #4a5568;
        }
        
        .closed-positions-table td {
            padding: 10px 16px;
            border-bottom: 1px solid rgba(74, 85, 104, 0.3);
        }
        
        .closed-positions-table tr:hover {
            background: rgba(99, 179, 237, 0.05);
        }
        
        /* Styles pour le bouton de dépliage des positions fermées */
        .expand-btn {
            background: linear-gradient(135deg, #3b82f6, #1e40af);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-right: 8px;
            min-width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .expand-btn:hover {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }
        
        .expand-icon {
            font-size: 0.8rem;
            line-height: 1;
        }
        
        /* Styles pour les détails des positions fermées dépliées */
        .closed-position-details {
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            border-bottom: 1px solid #4a5568;
        }
        
        .closed-position-card-detail {
            padding: 20px;
            border: 1px solid #4a5568;
            border-radius: 8px;
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            margin: 10px 0;
        }
        
        .card-header-closed {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #4a5568;
        }
        
        .token-name-closed {
            font-size: 1.3rem;
            font-weight: bold;
            color: #e2e8f0;
            margin-right: 12px;
        }
        
        .dex-badge-closed {
            background: linear-gradient(135deg, #4a5568, #2d3748);
            color: #cbd5e0;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 12px;
        }
        
        .status-closed {
            background: linear-gradient(135deg, #38a169, #2f855a);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .card-main-content-closed {
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            gap: 30px;
            align-items: flex-start;
        }
        
        .info-column-left-closed {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .performance-section-middle-closed {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            padding: 0 20px;
        }
        
        .activity-column-right-closed {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .activity-entry-closed {
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background: rgba(26, 32, 44, 0.5);
            border-radius: 6px;
            border: 1px solid #4a5568;
        }
        
        .enhanced-performance-bar-closed {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
        }
        
        .performance-bar-fill-closed {
            height: 8px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        
        .performance-bar-fill-closed.right {
            background: linear-gradient(90deg, #48bb78, #38a169);
        }
        
        .performance-bar-fill-closed.left {
            background: linear-gradient(90deg, #f56565, #e53e3e);
        }
        
        .performance-bar-label-closed {
            position: absolute;
            top: -25px;
            transform: translateX(-50%);
            font-size: 0.9rem;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 4px;
            background: rgba(26, 32, 44, 0.9);
            border: 1px solid #4a5568;
        }
        
        .performance-bar-label-closed.positive {
            color: #48bb78;
        }
        
        .performance-bar-label-closed.negative {
            color: #f56565;
        }
        
        .closed-status-center {
            text-align: center;
            margin-top: 15px;
        }
        
        .closed-badge {
            background: linear-gradient(135deg, #38a169, #2f855a);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            display: inline-block;
        }
        
        .no-data-message {
            text-align: center;
            color: #a0aec0;
            font-style: italic;
            padding: 20px;
        }
        
        /* Styles pour les positions fermées dépliées (utilisant la même structure que les ouvertes) */
        .position-closed {
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            border-left: 4px solid #38a169; /* Bordure verte pour indiquer que c'est fermé */
            opacity: 0.95;
        }
        
        .closed-final-price {
            font-size: 1rem;
            font-weight: bold;
            color: #e2e8f0;
        }
        
        .closed-status-badge {
            background: linear-gradient(135deg, #38a169, #2f855a);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .closed-icon {
            font-size: 1rem;
        }
        
        .closed-text {
            font-size: 0.85rem;
        }
        
        .closed-final-summary {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px 0;
        }
        
        .closed-badge-center {
            background: linear-gradient(135deg, #38a169, #2f855a);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            text-align: center;
            box-shadow: 0 2px 8px rgba(56, 161, 105, 0.3);
        }
        
        /* Responsive pour les positions fermées dépliées */
        @media (max-width: 1024px) {
            .card-main-content-closed {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .performance-section-middle-closed {
                padding: 0;
            }
        }
        
        /* ======================================================================================== */
        /* RESPONSIVE DESIGN */
        /* ======================================================================================== */
        
        @media (max-width: 1024px) {
            .card-header {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .performance-section {
                align-items: flex-start;
                text-align: left;
            }
            
            .sell-actions {
                align-items: flex-start;
            }
        }
        
        @media (max-width: 480px) {
            .sell-buttons {
                width: 100%;
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            
            .sell-btn {
                padding: 10px 8px;
                font-size: 0.9rem;
            }
            
            .position-card {
                margin: 0 -10px;
                border-radius: 8px;
            }
        }
        
        /* Nouvelle organisation stricte verticale */
        .positions-grid {
            display: block;
            width: 100%;
            margin-bottom: 40px;
        }
        .position-card {
            margin-bottom: 32px;
            width: 100%;
            max-width: none;
            margin-left: 0;
            margin-right: 0;
            padding-left: 32px;
            padding-right: 32px;
            box-sizing: border-box;
        }
        #positionsContent {
            display: block;
            width: 100%;
        }
        .section-header {
            margin: 32px 0 18px 0;
            width: 100%;
        }
        .closed-positions-table {
            margin-top: 32px;
            width: 100%;
            max-width: none;
            margin-left: 0;
            margin-right: 0;
            padding-left: 32px;
            padding-right: 32px;
            box-sizing: border-box;
        }
        @media (max-width: 900px) {
            .position-card, .closed-positions-table {
                padding-left: 8px;
                padding-right: 8px;
            }
        }
        
        </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left-section">
                <div class="status-item">
                    <div class="status-dot" id="connectionStatus"></div>
                    <span id="connectionText">Connexion...</span>
                </div>
            </div>
            <h1>💎 Counet PM</h1>
            <div class="header-right-section">
                <div class="header-info-item">
                    <span class="header-info-label">📡 Wallet:</span>
                    <span class="header-wallet-address" id="headerWalletAddressDisplay" title="CaBTVKEDpwkQLguTfSBRX9haxf4cW4KUexcMsvo8RTaB">CaBTV...8RTaB</span>
                </div>
                <div class="header-info-item">
                    <span class="header-info-label">⏰ MAJ:</span>
                    <span id="headerLastUpdate" class="header-timestamp">-</span>
                </div>
            </div>
        </div>

        <div class="dashboard">
            <div class="card">
                <h2>📊 Résumé des Positions</h2>
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="summary-value numeric-value" id="totalTransactions">-</div>
                        <div class="summary-label">Transactions</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value numeric-value" id="openPositions">-</div>
                        <div class="summary-label">Positions Ouvertes</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value numeric-value" id="closedPositions">-</div>
                        <div class="summary-label">Positions Fermées</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value numeric-value" id="totalInvested">-</div>
                        <div class="summary-label">Total Investi</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value numeric-value" id="totalPnL">-</div>
                        <div class="summary-label">PnL Total</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value numeric-value" id="avgPerformance">-</div>
                        <div class="summary-label">Perf Moyenne</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card main-card">
            <h2>💼 Positions Détaillées</h2>
            <div id="positionsContent">
                <div class="loading">
                    <div class="spinner"></div>
                    Chargement des positions...
                </div>
            </div>
        </div>
        
        <div id="notificationContainer" style="position: fixed; top: 20px; right: 20px; z-index: 1002;"></div>


        <div id="detailsModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">🔍 Détails de la Position</h3>
                    <button class="close-btn" onclick="closeDetailsModal()">✕ Fermer</button>
                </div>
                <div id="modalContent" class="json-viewer">
                    <!-- Le contenu JSON sera inséré ici -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // ====================================================================================
        // VARIABLES GLOBALES & INITIALISATION
        // ====================================================================================
        let ws;
        let positionManager;
        // let tradeCloser; // TradeCloser classe est définie plus bas si besoin
        let currentSellData = null; // SEULE DÉCLARATION GLOBALE DE currentSellData
        let performanceHistory = new Map();
        let reachedMilestones = new Map();
        let realtimePrices = new Map();
        let previousPrices = new Map();
        let priceDirections = new Map(); // Stocker les directions des prix
        let priceArrows = new Map();

        const reconnectDelay = 1000;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;


        // ====================================================================================
        // FONCTIONS UTILITAIRES (Simplifiées sans gestion wallet)
        // ====================================================================================
        
        function shortenAddress(address, chars = 4) {
            if (!address) return '';
            return `${address.substring(0, chars)}...${address.substring(address.length - chars)}`;
        }

        function showNotification(type, message, duration = 4000) {
            const container = document.getElementById('notificationContainer');
            if (!container) {
                console.warn('Notification container not found');
                alert(`${type.toUpperCase()}: ${message}`);
                return;
            }
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `<strong>${type.charAt(0).toUpperCase() + type.slice(1)}:</strong> ${message}`;
            notification.style.cssText = `padding:12px 18px; margin-bottom:10px; border-radius:6px; color:white; font-family:'IBM Plex Mono',monospace; font-size:0.9rem; box-shadow:0 2px 10px rgba(0,0,0,0.2); opacity:0; transform:translateX(100%); transition:opacity .3s ease,transform .3s ease;`;
            if (type === 'success') notification.style.backgroundColor = '#38a169';
            else if (type === 'error') notification.style.backgroundColor = '#e53e3e';
            else if (type === 'warning') notification.style.backgroundColor = '#dd6b20';
            else if (type === 'info') notification.style.backgroundColor = '#3182ce';
            else notification.style.backgroundColor = '#4a5568';
            container.appendChild(notification);
            setTimeout(() => { notification.style.opacity='1'; notification.style.transform='translateX(0)'; }, 10);
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => { if (container.contains(notification)) container.removeChild(notification); }, 300);
            }, duration);
        }

        // ====================================================================================
        // CLASSE POSITION MANAGER
        // ====================================================================================
        class PositionManager {
            constructor() {
                this.positionsData = [];
                this.transactionsData = [];
            }
            updateConnectionStatus(connected) {
                const statusDot = document.getElementById('connectionStatus');
                const statusText = document.getElementById('connectionText');
                if (!statusDot || !statusText) return;
                if (connected) {
                    statusDot.classList.remove('offline');
                    statusText.textContent = 'Connecté';
                } else {
                    statusDot.classList.add('offline');
                    statusText.textContent = 'Déconnecté';
                }
            }
            updatePositions(data) {
                if (!data) return;
                this.positionsData = data.positions || [];
                this.cleanupClosedPositions();
                this.updateValueWithAnimation('openPositions', data.openPositions || 0);
                this.updateValueWithAnimation('closedPositions', data.closedPositions || 0);
                this.updateValueWithAnimationAndSuffix('totalInvested', (data.totalInvested || 0).toFixed(4), 'SOL');
                const pnlElement = document.getElementById('totalPnL');
                const pnlValue = data.totalPnL || 0;
                this.updateValueWithAnimationAndSuffix('totalPnL', pnlValue.toFixed(4), 'SOL');
                if (pnlElement) pnlElement.className = `summary-value numeric-value ${pnlValue >= 0 ? 'pnl-positive' : 'pnl-negative'}`;
                const closedPositions = (this.positionsData || []).filter(p => p.status === 'CLOSED' && p.finalPnL !== undefined && p.totalInvested > 0);
                let avgPerformance = 0;
                if (closedPositions.length > 0) {
                    const totalPerformance = closedPositions.reduce((sum, p) => sum + ((p.finalPnL / p.totalInvested) * 100), 0);
                    avgPerformance = totalPerformance / closedPositions.length;
                }
                const avgPerfElement = document.getElementById('avgPerformance');
                const sign = avgPerformance >= 0 ? '+' : '';
                this.updateValueWithAnimationAndSuffix('avgPerformance', `${sign}${avgPerformance.toFixed(1)}`, '%');
                if (avgPerfElement) avgPerfElement.className = `summary-value numeric-value ${avgPerformance >= 0 ? 'pnl-positive' : 'pnl-negative'}`;
                this.renderPositionsTable(this.positionsData || []);
            }
            updateTransactions(data) {
                if (!data || !data.recent) return;
                this.transactionsData = data.recent || [];
                this.updateValueWithAnimation('totalTransactions', data.total || 0);
            }
            updateValueWithAnimation(elementId, newValue) {
                const element = document.getElementById(elementId);
                if (element && element.textContent !== newValue.toString()) element.textContent = newValue;
            }
            updateValueWithAnimationAndSuffix(elementId, newValue, suffix) {
                const element = document.getElementById(elementId);
                const newContent = `${newValue}<span class="sol-suffix">${suffix}</span>`;
                if (element && element.innerHTML !== newContent) element.innerHTML = newContent;
            }
            renderPositionsTable(positions) {
                const container = document.getElementById('positionsContent');
                if (!container) return;
                if (!positions || positions.length === 0) {
                    container.innerHTML = '<div class="loading">Aucune position trouvée</div>';
                    return;
                }
                
                const sortedPositions = [...positions].sort((a, b) => new Date(b.openedAt) - new Date(a.openedAt));
                
                // Séparer positions ouvertes et fermées
                const openPositions = sortedPositions.filter(p => p.status === 'OPEN');
                const closedPositions = sortedPositions.filter(p => p.status === 'CLOSED');
                
                let html = '';
                
                // Section positions ouvertes avec design cards
                if (openPositions.length > 0) {
                    html += '<div class="section-header"><h3>🟢 Positions Ouvertes</h3></div>';
                    html += '<div class="positions-grid">';
                    
                    openPositions.forEach(position => {
                        // Activer automatiquement le take profit pour les nouvelles positions
                        if (!takeProfitActive.has(position.mint)) {
                            enableTakeProfitByDefault(position.mint);
                        }
                        html += this.renderPositionCard(position);
                    });
                    
                    html += '</div>';
                }
                
                // Section positions fermées avec tableau compact
                if (closedPositions.length > 0) {
                    html += '<div class="section-header"><h3>📊 Historique des Trades</h3></div>';
                    html += this.renderClosedPositionsTable(closedPositions);
                }
                
                container.innerHTML = html;
            }
            
            renderPositionCard(position) {
                // Debug temporaire pour vérifier les calculs (seulement pour INC)
                if (position.tokenSymbol === 'INC') {
                    this.debugSellPrices(position);
                }
                
                const priceData = realtimePrices.get(position.mint);
                const currentPrice = priceData?.price || 0;
                const performance = this.calculatePerformanceValue(position);
                const performanceFormatted = this.calculatePerformance(position);
                
                // Détection des prix suspects
                let suspiciousClass = '';
                if (currentPrice && position.averagePriceUSD) {
                    const perfValue = ((currentPrice - position.averagePriceUSD) / position.averagePriceUSD) * 100;
                    const suspiciousData = this.detectSuspiciousPrice(position, perfValue);
                    if (suspiciousData.isSuspicious) {
                        suspiciousClass = 'suspicious-position';
                    }
                }
                
                return `
                    <div class="position-card-new ${suspiciousClass}" data-mint="${position.mint}">
                        <div class="card-header-new">
                            <div class="token-title-section">
                                <div class="token-name-new">${position.tokenSymbol || position.tokenName || 'N/A'}</div>
                                <div class="dex-badge-new">${this.formatDexName(position)}</div>
                                <div class="current-price-live">${this.formatDirectionalPrice(position)}</div>
                            </div>
                            <div class="header-controls">
                                <div class="sell-container-header">
                                    <button class="sell-btn-header sell-25-fast" onclick="initiateOptimizedSell('${position.mint}', 25)" data-percentage="25">
                                        <span class="sell-icon-new">⚡</span>
                                        <span class="sell-text-new">25%</span>
                                    </button>
                                    <button class="sell-btn-header sell-100-close" onclick="initiateOptimizedSell('${position.mint}', 100)" data-percentage="100" title="Fermer complètement la position">
                                        <span class="sell-icon-new">⚡</span>
                                        <span class="sell-text-new">Close</span>
                                    </button>
                                    <div class="fast-timer-new" id="fast-timer-${position.mint}" style="display: none;">
                                        <span class="timer-icon-new">⚡</span>
                                        <span class="fast-timer-value">0.0s</span>
                                    </div>
                                </div>
                                <div class="details-container-header">
                                    <button class="details-btn-header" onclick="showPositionDetails('${position.mint}')">
                                        <span class="details-icon-new">🔍</span>
                                        <span class="details-text-new">${this.formatTransactionCounts(position.transactions)}</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card-main-content">
                            <div class="info-column-left">
                                <div class="info-item-vertical">
                                    <div class="info-icon-vertical">📅</div>
                                    <div class="info-text-vertical">
                                        <div class="info-label-vertical">Ouvert le</div>
                                        <div class="info-value-vertical">${this.formatDate(position.openedAt)}</div>
                                    </div>
                                </div>
                                <div class="info-item-vertical">
                                    <div class="info-icon-vertical">💰</div>
                                    <div class="info-text-vertical">
                                        <div class="info-label-vertical">Investi</div>
                                        <div class="info-value-vertical">${position.totalInvested ? position.totalInvested.toFixed(4) : '0'} SOL</div>
                                    </div>
                                </div>
                                <div class="info-item-vertical">
                                    <div class="info-icon-vertical">🪙</div>
                                    <div class="info-text-vertical">
                                        <div class="info-label-vertical">Tokens</div>
                                        <div class="info-value-vertical">${this.formatTokenAmount(this.calculateTokenBalance(position))}</div>
                                    </div>
                                </div>
                                <div class="info-item-vertical">
                                    <div class="info-icon-vertical">📊</div>
                                    <div class="info-text-vertical">
                                        <div class="info-label-vertical">Performance</div>
                                        <div class="info-value-vertical">${this.calculateCurrentPerformance(position)}</div>
                                    </div>
                                </div>
                                <div class="info-item-vertical">
                                    <div class="info-icon-vertical">💵</div>
                                    <div class="info-text-vertical">
                                        <div class="info-label-vertical">Prix d'entrée</div>
                                        <div class="info-value-vertical">$${position.averagePriceUSD ? position.averagePriceUSD.toFixed(8) : '0.00000000'}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="performance-section-middle">
                                ${this.renderEnhancedPerformanceBar(position)}
                                <div class="tp-control-center">
                                    ${this.renderTakeProfitButton(position.mint)}
                                </div>
                            </div>
                            
                            <div class="activity-column-right">
                                <div class="activity-header">📋 Activité</div>
                                <div class="activity-entry">
                                    ${this.formatAllTransactions(position)}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            renderClosedPositionsTable(closedPositions) {
                let html = '';
                
                closedPositions.forEach(position => {
                    const isExpanded = expandedClosedPositions.has(position.mint);
                    const expandIcon = isExpanded ? '▼' : '▶';
                    
                    // Ligne principale du tableau
                    html += `
                        <tr class="closed-position-row" data-mint="${position.mint}">
                            <td class="center">${this.formatDate(position.openedAt)}</td>
                            <td class="center"><strong>${position.tokenSymbol || position.tokenName || 'N/A'}</strong></td>
                            <td class="center"><span class="dex-badge ${this.getDexClassFromPlatform(position)}">${this.formatDexName(position)}</span></td>
                            <td class="numeric-value right">${position.totalInvested.toFixed(4)}<span class="sol-suffix">SOL</span></td>
                            <td class="numeric-value right">${this.calculatePerformance(position)}</td>
                            <td class="numeric-value right ${(position.finalPnL || 0) >= 0 ? 'pnl-positive' : 'pnl-negative'}">${position.finalPnL ? position.finalPnL.toFixed(4) : '-'}<span class="sol-suffix">SOL</span></td>
                            <td class="center">
                                <div class="table-buttons">
                                    <button class="expand-btn" onclick="toggleClosedPositionDetails('${position.mint}')" title="Afficher les détails">
                                        <span class="expand-icon">${expandIcon}</span>
                                    </button>
                                    <button class="log-btn small" onclick="showTradeLogsModal('${position.mint}', '${position.tokenSymbol || position.tokenName || 'Token'}')">
                                        📊
                                    </button>
                                    <button class="details-btn" onclick="showPositionDetails('${position.mint}')">
                                        ${this.formatTransactionCounts(position.transactions)}
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                    
                    // Ligne détaillée (dépliable)
                    if (isExpanded) {
                        html += `
                            <tr class="closed-position-details" data-mint="${position.mint}">
                                <td colspan="7">
                                    ${this.renderClosedPositionCard(position)}
                                </td>
                            </tr>
                        `;
                    }
                });
                
                return `
                    <table class="closed-positions-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Token</th>
                                <th>DEX</th>
                                <th>Investi</th>
                                <th>Performance</th>
                                <th>PnL</th>
                                <th>Détails</th>
                            </tr>
                        </thead>
                        <tbody>${html}</tbody>
                    </table>
                `;
            }
            
            // Fonction pour afficher une position fermée en détail (même structure que position ouverte)
            renderClosedPositionCard(position) {
                return `
                    <div class="position-card-new position-closed" data-mint="${position.mint}">
                        <div class="card-header-new">
                            <div class="token-title-section">
                                <div class="token-name-new">${position.tokenSymbol || position.tokenName || 'N/A'}</div>
                                <div class="dex-badge-new">${this.formatDexName(position)}</div>
                                <div class="current-price-live closed-final-price">FERMÉE - ${this.formatClosedFinalPrice(position)}</div>
                            </div>
                            <div class="header-controls">
                                <div class="sell-container-header">
                                    <div class="closed-status-badge">
                                        <span class="closed-icon">📈</span>
                                        <span class="closed-text">Position fermée</span>
                                    </div>
                                </div>
                                <div class="details-container-header">
                                    <button class="details-btn-header" onclick="showPositionDetails('${position.mint}')">
                                        <span class="details-icon-new">🔍</span>
                                        <span class="details-text-new">${this.formatTransactionCounts(position.transactions)}</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card-main-content">
                            <div class="info-column-left">
                                <div class="info-item-vertical">
                                    <div class="info-icon-vertical">📅</div>
                                    <div class="info-text-vertical">
                                        <div class="info-label-vertical">Période</div>
                                        <div class="info-value-vertical">
                                            ${this.formatDate(position.openedAt)}<br>
                                            <small style="color: #a0aec0;">→ ${this.formatDate(position.closedAt)}</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="info-item-vertical">
                                    <div class="info-icon-vertical">💰</div>
                                    <div class="info-text-vertical">
                                        <div class="info-label-vertical">Investi</div>
                                        <div class="info-value-vertical">${position.totalInvested ? position.totalInvested.toFixed(4) : '0'} SOL</div>
                                    </div>
                                </div>
                                <div class="info-item-vertical">
                                    <div class="info-icon-vertical">🪙</div>
                                    <div class="info-text-vertical">
                                        <div class="info-label-vertical">Tokens (max)</div>
                                        <div class="info-value-vertical">${this.formatTokenAmount(this.calculateMaxTokenBalance(position))}</div>
                                    </div>
                                </div>
                                <div class="info-item-vertical">
                                    <div class="info-icon-vertical">📊</div>
                                    <div class="info-text-vertical">
                                        <div class="info-label-vertical">Performance</div>
                                        <div class="info-value-vertical">${this.calculatePerformance(position)}</div>
                                    </div>
                                </div>
                                <div class="info-item-vertical">
                                    <div class="info-icon-vertical">💵</div>
                                    <div class="info-text-vertical">
                                        <div class="info-label-vertical">Prix d'entrée</div>
                                        <div class="info-value-vertical">$${position.averagePriceUSD ? position.averagePriceUSD.toFixed(8) : '0.00000000'}</div>
                                    </div>
                                </div>
                                <div class="info-item-vertical">
                                    <div class="info-icon-vertical">🎯</div>
                                    <div class="info-text-vertical">
                                        <div class="info-label-vertical">PnL Final</div>
                                        <div class="info-value-vertical ${(position.finalPnL || 0) >= 0 ? 'pnl-positive' : 'pnl-negative'}">${position.finalPnL ? position.finalPnL.toFixed(4) : '-'} SOL</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="performance-section-middle">
                                ${this.renderClosedPerformanceBar(position)}
                                <div class="tp-control-center">
                                    <div class="closed-final-summary">
                                        <div class="closed-badge-center">Position fermée</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="activity-column-right">
                                <div class="activity-header">📋 Historique des Transactions</div>
                                <div class="activity-entry">
                                    ${this.formatAllTransactions(position)}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Calculer le maximum de tokens détenus pour une position fermée
            calculateMaxTokenBalance(position) {
                if (!position.transactions || position.transactions.length === 0) return 0;
                
                let maxTokens = 0;
                let currentTokens = 0;
                
                position.transactions.forEach(tx => {
                    if (tx.type === 'BUY' && tx.amount) {
                        currentTokens += tx.amount;
                        maxTokens = Math.max(maxTokens, currentTokens);
                    } else if (tx.type === 'SELL' && tx.amount) {
                        currentTokens -= tx.amount;
                    }
                });
                
                return maxTokens;
            }
            
            // Fonction pour formater le prix final d'une position fermée
            formatClosedFinalPrice(position) {
                if (!position.finalPnL || !position.totalInvested) {
                    return 'Données insuffisantes';
                }
                
                const performance = (position.finalPnL / position.totalInvested) * 100;
                const sign = performance >= 0 ? '+' : '';
                const color = performance >= 0 ? '#22c55e' : '#ef4444';
                
                return `<span style="color: ${color}; font-weight: bold;">${sign}${performance.toFixed(1)}%</span>`;
            }
            
            // Barre de performance pour les positions fermées (exactement identique aux positions ouvertes)
            renderClosedPerformanceBar(position) {
                if (!position.finalPnL || !position.totalInvested) {
                    return `
                        <div class="enhanced-performance-bar">
                            <div class="performance-bar-track">
                                <div class="performance-bar-center-new" style="left: 33.33%;"></div>
                                <div class="performance-bar-center-label-new" style="left: 33.33%;">0%</div>
                                <div class="no-data-message">Données insuffisantes</div>
                            </div>
                        </div>
                    `;
                }
                
                const performance = (position.finalPnL / position.totalInvested) * 100;
                const isPositive = performance >= 0;
                
                // Utiliser la même échelle que les positions ouvertes (HIGH par défaut)
                const maxGain = 1000; // Même que HIGH
                const maxLoss = 100;
                
                let barWidth;
                if (isPositive) {
                    // Côté gains : utilise 2/3 de la barre (66.67%) - exactement comme les positions ouvertes
                    const clampedGain = Math.min(performance, maxGain);
                    barWidth = (clampedGain / maxGain) * 66.67; // 2/3 de la barre
                } else {
                    // Côté pertes : utilise 1/3 de la barre (33.33%) - exactement comme les positions ouvertes
                    const clampedLoss = Math.min(Math.abs(performance), maxLoss);
                    barWidth = (clampedLoss / maxLoss) * 33.33; // 1/3 de la barre
                }
                
                // Construction de la barre avec la même logique que les positions ouvertes
                let barHTML = '';
                if (isPositive) {
                    barHTML = `<div class="performance-bar-fill right" style="width: ${barWidth}%; left: 33.33%;"></div>`;
                } else {
                    barHTML = `<div class="performance-bar-fill left" style="width: ${barWidth}%; right: 66.67%;"></div>`;
                }
                
                // Label de performance positionné exactement comme les positions ouvertes
                const labelPosition = isPositive ? 
                    `left: ${33.33 + barWidth/2}%` : 
                    `right: ${66.67 + barWidth/2}%`;
                const labelClass = isPositive ? 'positive' : 'negative';
                const labelHTML = `<div class="performance-bar-label ${labelClass}" style="${labelPosition};">${isPositive ? '+' : ''}${performance.toFixed(1)}%</div>`;
                
                return `
                    <div class="enhanced-performance-bar">
                        <div class="performance-bar-track">
                            <div class="performance-bar-center-new" style="left: 33.33%;"></div>
                            <div class="performance-bar-center-label-new" style="left: 33.33%;">0%</div>
                            ${barHTML}
                            ${labelHTML}
                        </div>
                    </div>
                `;
            }
            
            formatDexName(position) {
                if (position.platformInfo) {
                    const { dexName } = position.platformInfo;
                    if (dexName?.toLowerCase().includes('pump.fun')) return 'PUMP.FUN';
                    if (dexName?.toLowerCase().includes('raydium')) {
                        if (dexName.toLowerCase().includes('cpmm')) return 'RAYDIUM CPMM';
                        return 'RAYDIUM AMM';
                    }
                    if (dexName?.toLowerCase().includes('meteora')) return 'METEORA';
                    if (dexName?.toLowerCase().includes('orca')) return 'ORCA';
                    if (dexName?.toLowerCase().includes('jupiter')) return 'JUPITER';
                    return dexName?.toUpperCase() || 'UNKNOWN';
                }
                
                const dexId = position.metadataExtra?.dexId;
                const dexNames = {
                    'raydium': 'RAYDIUM',
                    'pump': 'PUMP.FUN',
                    'meteora': 'METEORA',
                    'orca': 'ORCA'
                };
                return dexNames[dexId?.toLowerCase()] || dexId?.toUpperCase() || 'UNKNOWN';
            }
            
            formatDirectionalPrice(position) {
                const priceData = realtimePrices.get(position.mint);
                const previousPrice = previousPrices.get(position.mint);
                
                if (!priceData?.price) return '<span class="price-loading">⏳ Loading...</span>';
                
                let direction = '';
                let directionClass = '';
                
                // Garder la direction stockée ou déterminer une nouvelle
                const storedDirection = priceDirections.get(position.mint);
                
                if (previousPrice && priceData.price !== previousPrice) {
                    direction = priceData.price > previousPrice ? '▲' : '▼';
                    directionClass = priceData.price > previousPrice ? 'price-up' : 'price-down';
                    // Stocker la nouvelle direction
                    priceDirections.set(position.mint, { direction, directionClass, timestamp: Date.now() });
                } else if (storedDirection && (Date.now() - storedDirection.timestamp) < 30000) {
                    // Utiliser la direction stockée si moins de 30 secondes
                    direction = storedDirection.direction;
                    directionClass = storedDirection.directionClass;
                }
                
                // Déterminer la source et sa couleur
                const source = priceData.source || 'unknown';
                let sourceColor = '#a0aec0'; // Gris par défaut
                let sourceText = '';
                
                if (source === 'jupiter' || source === 'jupiter_batch') {
                    sourceColor = '#00d4aa'; // Vert Jupiter
                    sourceText = 'J';
                } else if (source === 'dexscreener' || source === 'dexscreener_fallback') {
                    sourceColor = '#3b82f6'; // Bleu DexScreener
                    sourceText = 'D';
                } else if (source === 'helius_realtime') {
                    sourceColor = '#f97316'; // Orange Helius
                    sourceText = 'H';
                } else if (source === 'gmgn' || source === 'gmgn_realtime' || source === 'GMGN') {
                    sourceColor = '#22c55e'; // Vert GMGN
                    sourceText = 'GMGN';
                } else {
                    sourceText = '?';
                }
                
                return `
                    <div class="price-display-container">
                        <span class="price-arrow ${directionClass}">${direction}</span>
                        <span class="price-value">$${priceData.price.toFixed(8)}</span>
                        <span class="price-source" style="color: ${sourceColor}; font-size: 0.7rem; font-weight: bold; margin-left: 4px; opacity: 0.8;" title="${source.toUpperCase()}">${sourceText}</span>
                    </div>
                `;
            }
            
            calculatePerformanceValue(position) {
                const priceData = realtimePrices.get(position.mint);
                if (!priceData?.price || !position.averagePriceUSD) return 0;
                return ((priceData.price - position.averagePriceUSD) / position.averagePriceUSD) * 100;
            }
            updateHealth(data) { /* Placeholder */ }
            updateLastUpdate() {
                const timeString = new Date().toLocaleTimeString('fr-FR', { hour:'2-digit', minute:'2-digit', second:'2-digit' });
                const element = document.getElementById('headerLastUpdate');
                if (element) element.textContent = timeString;
            }
            formatTokenAmount(amount) {
                if (typeof amount !== 'number' || isNaN(amount) || amount === 0) return '0';
                if (amount >= 1e6) return (amount / 1e6).toFixed(2) + 'M';
                if (amount >= 1e3) return (amount / 1e3).toFixed(2) + 'K';
                if (amount >= 1) return amount.toFixed(2);
                return amount.toPrecision(3);
            }
            
            calculateTokenBalance(position) {
                if (!position.transactions || position.transactions.length === 0) return 0;
                
                let totalTokens = 0;
                position.transactions.forEach(tx => {
                    if (tx.type === 'BUY' && tx.amount) {
                        totalTokens += tx.amount;
                    } else if (tx.type === 'SELL' && tx.amount) {
                        totalTokens -= tx.amount;
                    }
                });
                
                return Math.max(0, totalTokens); // Ne pas retourner de valeur négative
            }
            formatDexWithLogic(position) {
                if (position.platformInfo) {
                    const { dexName, logicBranch, calculationMethod } = position.platformInfo;
                    let displayName = dexName;
                    if (dexName.toLowerCase().includes('pump.fun')) displayName = 'PUMPFUN';
                    let cleanLogicBranch = logicBranch || '';
                    if (cleanLogicBranch.startsWith('Source: ')) cleanLogicBranch = cleanLogicBranch.replace('Source: ', '');
                    if (cleanLogicBranch.startsWith('SOURCE: ')) cleanLogicBranch = cleanLogicBranch.replace('SOURCE: ', '');
                    let methodColor = '#a0aec0';
                    if (calculationMethod === 'Native') methodColor = '#68d391';
                    else if (calculationMethod === 'WSOL') methodColor = '#fbb6ce';
                    else if (calculationMethod === 'Mixed') methodColor = '#f6ad55';
                    return `<div style="text-align:center;"><div style="font-weight:700;font-size:0.8rem;margin-bottom:3px;">${displayName}</div><div style="font-size:0.6rem;color:${methodColor};line-height:1.1;">${cleanLogicBranch}</div></div>`;
                }
                const dexId = position.metadataExtra?.dexId;
                const dexNames = { /* ... */ };
                return dexNames[dexId?.toLowerCase()] || dexId?.charAt(0).toUpperCase() + dexId?.slice(1) || '-';
            }
            formatDate(dateString) {
                if (!dateString) return '-';
                const date = new Date(dateString);
                const day = date.getDate().toString().padStart(2, '0');
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                return `${day}/${month} ${hours}:${minutes}`;
            }
            
            formatDateShort(dateString) {
                if (!dateString) return '-';
                const date = new Date(dateString);
                const day = date.getDate().toString().padStart(2, '0');
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                return `${day}/${month} ${hours}:${minutes}`;
            }
            getDexClassFromPlatform(position) {
                if (position.platformInfo) {
                    const dexName = (position.platformInfo.dexName || '').toLowerCase();
                    if (dexName.includes('pump')) return 'pump';
                    if (dexName.includes('raydium cpmm')) return 'raydium-cpmm';
                    if (dexName.includes('raydium')) return 'raydium';
                    if (dexName.includes('meteora')) return 'meteora';
                    if (dexName.includes('orca')) return 'orca';
                    if (dexName.includes('jupiter')) return 'jupiter';
                    return 'other';
                }
                const dexId = position.metadataExtra?.dexId;
                const dexClasses = { 'raydium': 'raydium', 'raydium cpmm': 'raydium-cpmm', 'pump': 'pump', 'pump.fun': 'pump', 'meteora': 'meteora' };
                return dexClasses[dexId?.toLowerCase()] || 'unknown';
            }
            calculatePerformance(position) {
                if (position.status !== 'OPEN') {
                    if (position.finalPnL !== undefined && position.totalInvested > 0) {
                        const finalPerformance = (position.finalPnL / position.totalInvested) * 100;
                        const isPositive = finalPerformance >= 0;
                        return `<span class="${isPositive ? 'pnl-positive' : 'pnl-negative'}">${isPositive ? '+' : ''}${finalPerformance.toFixed(1)}%</span>`;
                    }
                    return '-';
                }
                
                const priceData = realtimePrices.get(position.mint);
                if (!priceData || !priceData.price || !position.averagePriceUSD) return '<span style="color:#a0aec0;">-</span>';
                if ((Date.now() - priceData.timestamp) > 15000) return '<span style="color:#a0aec0;">(stale)</span>';
                
                const performance = ((priceData.price - position.averagePriceUSD) / position.averagePriceUSD) * 100;
                const isPositive = performance >= 0;
                
                // 🚨 SYSTÈME D'ALERTE : Détection des prix suspects
                const suspiciousData = this.detectSuspiciousPrice(position, performance);
                if (suspiciousData.isSuspicious) {
                    return `<span class="${isPositive ? 'pnl-positive' : 'pnl-negative'} suspicious-price" 
                            title="${suspiciousData.reason}" 
                            style="background: ${suspiciousData.alertColor}; padding: 2px 4px; border-radius: 3px; color: white; font-weight: bold; cursor: help;">
                            ⚠️ ${isPositive ? '+' : ''}${performance.toFixed(1)}%
                        </span>`;
                }
                
                return `<span class="${isPositive ? 'pnl-positive' : 'pnl-negative'}">${isPositive ? '+' : ''}${performance.toFixed(1)}%</span>`;
            }

            // 🚨 SYSTÈME D'ALERTE : Détection des prix d'achat incohérents
            detectSuspiciousPrice(position, currentPerformance) {
                const result = {
                    isSuspicious: false,
                    reason: '',
                    alertColor: '#ff6b6b' // Rouge par défaut
                };

                // Critère 1: Performance immédiate trop élevée (>150% dans les premières minutes)
                const positionAge = Date.now() - new Date(position.openedAt).getTime();
                const ageInMinutes = positionAge / (1000 * 60);
                
                if (ageInMinutes < 30 && currentPerformance > 150) {
                    result.isSuspicious = true;
                    result.reason = `🚨 ALERTE PRIX SUSPECT: Performance de +${currentPerformance.toFixed(1)}% en ${ageInMinutes.toFixed(1)} minutes. Possible erreur de calcul du prix d'achat.`;
                    result.alertColor = '#ff4444'; // Rouge vif
                    return result;
                }

                // Critère 2: Performance très élevée avec investissement faible (possiblement mauvais calcul)
                if (currentPerformance > 200 && position.totalInvested < 0.01) {
                    result.isSuspicious = true;
                    result.reason = `⚠️ PRIX SUSPECT: Performance +${currentPerformance.toFixed(1)}% avec investissement très faible (${position.totalInvested} SOL). Vérifiez le calcul.`;
                    result.alertColor = '#ff8800'; // Orange
                    return result;
                }

                // Critère 3: Performance extreme (>500%)
                if (Math.abs(currentPerformance) > 500) {
                    result.isSuspicious = true;
                    result.reason = `🔥 PERFORMANCE EXTREME: ${currentPerformance > 0 ? '+' : ''}${currentPerformance.toFixed(1)}%. Données à vérifier.`;
                    result.alertColor = currentPerformance > 0 ? '#ff6600' : '#cc0000';
                    return result;
                }

                // Critère 4: Prix d'achat anormalement bas par rapport au prix actuel
                const priceData = realtimePrices.get(position.mint);
                if (priceData && position.averagePriceUSD) {
                    const priceRatio = priceData.price / position.averagePriceUSD;
                    if (priceRatio > 10) { // Prix actuel 10x supérieur au prix d'achat
                        result.isSuspicious = true;
                        result.reason = `📊 RATIO PRIX ANORMAL: Prix actuel ${priceRatio.toFixed(1)}x supérieur au prix d'achat. Possible erreur de calcul.`;
                        result.alertColor = '#ff9900'; // Orange foncé
                        return result;
                    }
                }

                return result;
            }
            calculateSellPrice(position) {
                if (!position.transactions || position.transactions.length === 0) return '-';
                const sellTransactions = position.transactions.filter(tx => tx.type === 'SELL' && tx.priceUSD && tx.priceUSD > 0);
                if (sellTransactions.length === 0) return '-';
                let totalSoldAmount = 0, totalSoldValue = 0;
                sellTransactions.forEach(tx => { totalSoldAmount += tx.amount; totalSoldValue += tx.amount * tx.priceUSD; });
                if (totalSoldAmount === 0) return '-';
                return '$' + (totalSoldValue / totalSoldAmount).toFixed(8);
            }
            showError(message) { showNotification('error', message); }
            
            // Rendu du bouton Take Profit avec sélection de grille
            renderTakeProfitButton(mint) {
                const activeGrid = takeProfitActive.get(mint) || false;
                let buttonText, buttonIcon, buttonColor, buttonClass, tooltip;
                
                if (activeGrid === false) {
                    buttonText = 'TP OFF';
                    buttonIcon = '🎯';
                    buttonColor = '#64748b';
                    buttonClass = '';
                    tooltip = 'Cliquez pour activer la grille HIGH';
                } else if (activeGrid === 'high') {
                    buttonText = 'HIGH';
                    buttonIcon = '🚀';
                    buttonColor = TP_GRIDS.high.color;
                    buttonClass = 'active';
                    tooltip = 'Grille HIGH active: +100%/+200%/+500%/+1000% - Cliquez pour passer à SMALL';
                } else if (activeGrid === 'small') {
                    buttonText = 'SMALL';
                    buttonIcon = '⚡';
                    buttonColor = TP_GRIDS.small.color;
                    buttonClass = 'active';
                    tooltip = 'Grille SMALL active: +10%/+25%/+75%/+100% - Cliquez pour désactiver';
                }
                
                return `
                    <button class="tp-btn-center ${buttonClass}" 
                            onclick="toggleTakeProfit('${mint}')" 
                            title="${tooltip}"
                            style="background-color: ${buttonColor}; border-color: ${buttonColor};">
                        <span class="tp-icon-center">${buttonIcon}</span>
                        <span class="tp-text-center">${buttonText}</span>
                    </button>
                `;
            }
            
            formatTransactionCounts(transactions) {
                if (!transactions || transactions.length === 0) return '0/0';
                const buyCount = transactions.filter(tx => tx.type === 'BUY').length;
                const sellCount = transactions.filter(tx => tx.type === 'SELL').length;
                const buyColor = buyCount > 0 ? '#68d391' : '#a0aec0';
                const sellColor = sellCount > 0 ? '#fc8181' : '#a0aec0';
                return `<span style="color:${buyColor};font-weight:600;">${buyCount}</span>/<span style="color:${sellColor};font-weight:600;">${sellCount}</span>`;
            }
            
            formatAllTransactions(position) {
                if (!position.transactions || position.transactions.length === 0) {
                    return `<div class="activity-line">${this.formatDateShort(position.openedAt)} Achat ${this.formatTokenAmount(this.calculateTokenBalance(position))} - $${position.averagePriceUSD ? position.averagePriceUSD.toFixed(8) : '0.00000000'}</div>`;
                }
                
                // Trier les transactions par date (plus récente en premier)
                const sortedTransactions = [...position.transactions].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                let html = '';
                sortedTransactions.forEach(tx => {
                    if (tx.type === 'BUY') {
                        // Prix d'achat : solAmount dépensé / tokens reçus * prix SOL actuel
                        const price = (tx.solAmount && tx.amount) ? (tx.solAmount / tx.amount) * this.getSolPriceUSD() : 0;
                        html += `<div class="activity-line">${this.formatDateShort(tx.timestamp)} 💎 Achat ${this.formatTokenAmount(tx.amount)} - $${price ? price.toFixed(8) : '0.00000000'}</div>`;
                    } else if (tx.type === 'SELL') {
                        // 🎯 NOUVEAU SYSTÈME DE DÉTECTION DES TP ATTEINTS
                        let sellIcon = '';
                        let sellTypeText = '';
                        
                        if (tx.sellType === 'TP') {
                            // C'est un TP automatique - utiliser une cible et le numéro/pourcentage
                            sellIcon = '🎯';
                            
                            // Essayer de déterminer quel TP a été atteint en analysant le contexte
                            const tpInfo = this.detectTpLevelFromTransaction(tx, position);
                            if (tpInfo) {
                                sellTypeText = `TP${tpInfo.level} ${tpInfo.percentage}%`;
                            } else {
                                sellTypeText = 'TP'; // Fallback
                            }
                        } else if (tx.sellType === 'SL') {
                            sellIcon = '🛑';
                            sellTypeText = 'SL';
                        } else {
                            // Vente manuelle - garder le sac de dollars
                            sellIcon = '💰';
                            sellTypeText = 'Vente';
                        }
                        
                        // Prix de vente RÉEL : utiliser le prix USD stocké au moment de la transaction
                        let price = 0;
                        if (tx.amount) {
                            // Priorité 1: priceUSD (prix réel stocké au moment de la transaction)
                            if (tx.priceUSD && tx.priceUSD > 0) {
                                price = tx.priceUSD;
                            }
                            // Priorité 2: calculer avec solPriceAtTime (prix SOL au moment de la transaction)
                            else if (tx.solPriceAtTime && (tx.solReceived || tx.solAmount)) {
                                const solReceived = tx.solReceived || tx.solAmount || 0;
                                if (solReceived > 0) {
                                    price = (solReceived / tx.amount) * tx.solPriceAtTime;
                                }
                            }
                            // Priorité 3: fallback avec prix SOL actuel (pour compatibilité anciennes transactions)
                            else {
                                const solReceived = tx.solReceived || tx.solAmount || 0;
                                if (solReceived > 0) {
                                    price = (solReceived / tx.amount) * this.getSolPriceUSD();
                                }
                            }
                        }
                        html += `<div class="activity-line">${this.formatDateShort(tx.timestamp)} ${sellIcon} ${sellTypeText} ${this.formatTokenAmount(tx.amount)} - $${price ? price.toFixed(8) : '0.00000000'}</div>`;
                    }
                });
                
                return html || `<div class="activity-line">${this.formatDateShort(position.openedAt)} 💎 Achat ${this.formatTokenAmount(this.calculateTokenBalance(position))} - $${position.averagePriceUSD ? position.averagePriceUSD.toFixed(8) : '0.00000000'}</div>`;
            }
            
            getSolPriceUSD() {
                // Prix SOL cohérent avec GMGN pour la période 01/06 - environ 156.87 USD
                return 156.87; // Prix SOL correct basé sur les données stockées: solPriceAtTime
            }
            
            // 🎯 DÉTECTER QUEL TP A ÉTÉ ATTEINT pour l'affichage correct
            detectTpLevelFromTransaction(tx, position) {
                if (!tx || tx.sellType !== 'TP' || !position) return null;
                
                // Méthode 1: Analyser les informations stockées dans l'historique TP
                const tpInfo = getTpAchievedInfo(position.mint);
                if (tpInfo && tpInfo.grid) {
                    const grid = TP_GRIDS[tpInfo.grid];
                    if (grid) {
                        // Chercher quel niveau correspond au pourcentage vendu (approximatif)
                        for (let i = 0; i < grid.levels.length; i++) {
                            const level = grid.levels[i];
                            const levelKey = `tp${i + 1}`;
                            
                            // Vérifier si ce TP a été atteint récemment (dans les 5 minutes de la transaction)
                            if (tpInfo.timestamps[levelKey]) {
                                const tpTime = tpInfo.timestamps[levelKey];
                                const txTime = new Date(tx.timestamp).getTime();
                                
                                if (Math.abs(txTime - tpTime) < 5 * 60 * 1000) { // 5 minutes
                                    return {
                                        level: i + 1,
                                        percentage: `+${level.threshold}`,
                                        grid: tpInfo.grid
                                    };
                                }
                            }
                        }
                    }
                }
                
                // Méthode 2: Analyser le pourcentage de vente pour deviner le niveau
                // Les TP vendent généralement 25% (grille High/Small standard)
                if (tx.percentage && Math.abs(tx.percentage - 25) < 5) {
                    // C'est probablement un TP standard, essayer de deviner lequel
                    if (position.averagePriceUSD && tx.priceUSD) {
                        const performance = ((tx.priceUSD - position.averagePriceUSD) / position.averagePriceUSD) * 100;
                        
                        // Grille Small
                        if (performance >= 10 && performance < 25) return { level: 1, percentage: '+10', grid: 'small' };
                        if (performance >= 25 && performance < 75) return { level: 2, percentage: '+25', grid: 'small' };
                        if (performance >= 75 && performance < 100) return { level: 3, percentage: '+75', grid: 'small' };
                        if (performance >= 100 && performance < 200) return { level: 4, percentage: '+100', grid: 'small' };
                        
                        // Grille High
                        if (performance >= 100 && performance < 200) return { level: 1, percentage: '+100', grid: 'high' };
                        if (performance >= 200 && performance < 500) return { level: 2, percentage: '+200', grid: 'high' };
                        if (performance >= 500 && performance < 1000) return { level: 3, percentage: '+500', grid: 'high' };
                        if (performance >= 1000) return { level: 4, percentage: '+1000', grid: 'high' };
                    }
                }
                
                // Fallback: pas d'information précise
                return null;
            }
            
            // Fonction de diagnostic pour vérifier les calculs de prix de vente RÉELS
            debugSellPrices(position) {
                if (!position.transactions) return;
                
                console.log(`🔍 DIAGNOSTIC PRIX VENTE RÉEL - ${position.tokenSymbol}:`);
                position.transactions.filter(tx => tx.type === 'SELL').forEach((tx, i) => {
                    // Logique identique à formatAllTransactions
                    let actualPrice = 0;
                    let priceSource = '';
                    
                    if (tx.priceUSD && tx.priceUSD > 0) {
                        actualPrice = tx.priceUSD;
                        priceSource = 'priceUSD stocké';
                    } else if (tx.solPriceAtTime && (tx.solReceived || tx.solAmount)) {
                        const solReceived = tx.solReceived || tx.solAmount || 0;
                        if (solReceived > 0) {
                            actualPrice = (solReceived / tx.amount) * tx.solPriceAtTime;
                            priceSource = 'calculé avec solPriceAtTime';
                        }
                    } else {
                        const solReceived = tx.solReceived || tx.solAmount || 0;
                        if (solReceived > 0) {
                            actualPrice = (solReceived / tx.amount) * this.getSolPriceUSD();
                            priceSource = 'fallback prix SOL fixe';
                        }
                    }
                    
                    console.log(`  Vente ${i+1}: ${tx.amount} tokens`);
                    console.log(`    - priceUSD stocké: $${tx.priceUSD || 'NON DÉFINI'}`);
                    console.log(`    - solPriceAtTime: $${tx.solPriceAtTime || 'NON DÉFINI'}`);
                    console.log(`    - solReceived: ${tx.solReceived || 'NON DÉFINI'}`);
                    console.log(`    - solAmount: ${tx.solAmount || 'NON DÉFINI'}`);
                    console.log(`    - Prix RÉEL utilisé: $${actualPrice.toFixed(8)} (${priceSource})`);
                    console.log(`    ---`);
                });
            }
            
            calculateCurrentPerformance(position) {
                if (!position.transactions || position.transactions.length === 0) {
                    // Pas de transactions, utiliser la performance simple
                    const priceData = realtimePrices.get(position.mint);
                    if (!priceData?.price || !position.averagePriceUSD) return '-';
                    const performance = ((priceData.price - position.averagePriceUSD) / position.averagePriceUSD) * 100;
                    const isPositive = performance >= 0;
                    return `<span style="color: ${isPositive ? '#68d391' : '#fc8181'}; font-weight: 700;">${isPositive ? '+' : ''}${performance.toFixed(1)}%</span>`;
                }
                
                // Calculer le coût total des achats
                const buyTransactions = position.transactions.filter(tx => tx.type === 'BUY');
                const sellTransactions = position.transactions.filter(tx => tx.type === 'SELL');
                
                let totalCostSOL = 0;
                let totalTokensBought = 0;
                
                buyTransactions.forEach(tx => {
                    totalCostSOL += tx.solAmount || 0;
                    totalTokensBought += tx.amount || 0;
                });
                
                // Calculer les revenus des ventes en utilisant les vrais montants SOL reçus
                let totalRevenueSOL = 0;
                let totalTokensSold = 0;
                
                sellTransactions.forEach(tx => {
                    // Utiliser solReceived en priorité, sinon solAmount, sinon 0
                    const solReceived = tx.solReceived || tx.solAmount || 0;
                    totalRevenueSOL += solReceived;
                    totalTokensSold += tx.amount || 0;
                });
                
                // Tokens restants
                const remainingTokens = totalTokensBought - totalTokensSold;
                
                // Valeur actuelle des tokens restants en SOL (conversion correcte)
                const priceData = realtimePrices.get(position.mint);
                let currentValueSOL = 0;
                if (priceData?.price && remainingTokens > 0) {
                    // Prix du token en USD, converti en SOL
                    const tokenValueUSD = priceData.price * remainingTokens;
                    currentValueSOL = tokenValueUSD / this.getSolPriceUSD();
                }
                
                // Performance = (Revenus ventes NETS + Valeur actuelle - Coût total) / Coût total * 100
                // IMPORTANT: Utilise maintenant les vrais montants SOL reçus (nets) et non les montants bruts
                const totalValue = totalRevenueSOL + currentValueSOL;
                if (totalCostSOL <= 0) return '-';
                
                const performance = ((totalValue - totalCostSOL) / totalCostSOL) * 100;
                const isPositive = performance >= 0;
                return `<span style="color: ${isPositive ? '#68d391' : '#fc8181'}; font-weight: 700;">${isPositive ? '+' : ''}${performance.toFixed(1)}%</span>`;
            }
            renderEnhancedPerformanceBar(position) {
                const priceData = realtimePrices.get(position.mint);
                if (!priceData?.price || !position.averagePriceUSD) {
                    return `
                        <div class="enhanced-performance-bar">
                            <div class="performance-bar-track">
                                <div class="performance-bar-loading">
                                    <div class="loading-shimmer"></div>
                                </div>
                                <div class="performance-bar-center"></div>
                                <div class="performance-bar-center-label">BE</div>
                            </div>
                            <div class="performance-indicators">
                                <span class="performance-value">Prix en attente...</span>
                            </div>
                        </div>
                    `;
                }
                
                const performance = ((priceData.price - position.averagePriceUSD) / position.averagePriceUSD) * 100;
                const isPositive = performance >= 0;
                
                // Récupérer la grille active pour ce token d'abord
                const activeGrid = takeProfitActive.get(position.mint) || 'high'; // Fallback sur high
                const currentGrid = TP_GRIDS[activeGrid] || TP_GRIDS.high; // Double fallback
                
                // Échelle dynamique selon la grille active
                const maxGain = activeGrid === 'small' ? 100 : 1000; // +100% pour SMALL, +1000% pour HIGH
                const maxLoss = 100;  // -100% minimum (toujours pareil)
                
                let barWidth;
                if (isPositive) {
                    // Côté gains : utilise 2/3 de la barre (66.67%)
                    const clampedGain = Math.min(performance, maxGain);
                    barWidth = (clampedGain / maxGain) * 66.67; // 2/3 de la barre
                } else {
                    // Côté pertes : utilise 1/3 de la barre (33.33%)
                    const clampedLoss = Math.min(Math.abs(performance), maxLoss);
                    barWidth = (clampedLoss / maxLoss) * 33.33; // 1/3 de la barre
                }
                
                // Marqueurs Take Profit étagés et Stop Loss avec grilles multiples
                const markers = [];
                
                // Stop Loss marqueur (côté gauche) 
                const stopLossPosition = (Math.abs(currentGrid.stopLoss.threshold) / maxLoss) * 33.33;
                const slTriggered = takeProfitTriggered.get(position.mint)?.sl || false;
                const slColor = '#fc8181'; // Même rouge que le pourcentage
                const slBgColor = slTriggered ? slColor : '#4a5568';
                const slTextColor = slTriggered ? '#ffffff' : slColor;
                
                markers.push(`
                    <div class="sl-marker-simple" style="left: ${33.33 - stopLossPosition}%;">
                        <div class="sl-line"></div>
                        <div class="sl-label-enhanced" style="color: ${slTextColor}; background-color: ${slBgColor};">
                            <div class="sl-label-name">SL</div>
                            <div class="sl-label-percent">${currentGrid.stopLoss.threshold}%</div>
                        </div>
                    </div>
                `);
                
                // Take Profit marqueurs selon la grille active avec HISTORIQUE PERSISTANT
                if (activeGrid !== false && currentGrid.levels) {
                    const tpColor = '#22c55e'; // Toujours vert pour tous les marqueurs TP
                    currentGrid.levels.forEach((level, index) => {
                        const tpPosition = (level.threshold / maxGain) * 66.67;
                        if (tpPosition <= 66.67) {
                            const levelKey = `tp${index + 1}`;
                            
                            // 🎯 UTILISER L'HISTORIQUE PERSISTANT + état temporaire
                            const triggeredSession = takeProfitTriggered.get(position.mint)?.[levelKey] || false;
                            const triggeredPersistent = isTpAchieved(position.mint, levelKey);
                            const triggered = triggeredSession || triggeredPersistent;
                            
                            const bgColor = triggered ? tpColor : '#4a5568'; // Fond vert si déclenché, gris sinon
                            const textColor = triggered ? '#ffffff' : '#22c55e'; // Blanc si déclenché, vert sinon
                            
                            markers.push(`
                                <div class="tp-marker-simple" style="left: ${33.33 + tpPosition}%;">
                                    <div class="tp-line" style="background: ${tpColor};"></div>
                                    <div class="tp-label-enhanced tp${index + 1}" style="color: ${textColor}; background-color: ${bgColor};">
                                        <div class="tp-label-name">TP${index + 1}</div>
                                        <div class="tp-label-percent">+${level.threshold}%</div>
                                    </div>
                                </div>
                            `);
                        }
                    });
                }
                
                // Construction de la barre avec nouvelle échelle
                let barHTML = '';
                if (isPositive) {
                    barHTML = `<div class="performance-bar-fill right" style="width: ${barWidth}%; left: 33.33%;"></div>`;
                } else {
                    barHTML = `<div class="performance-bar-fill left" style="width: ${barWidth}%; right: 66.67%;"></div>`;
                }
                
                // Label de performance positionné selon la nouvelle échelle
                const labelPosition = isPositive ? 
                    `left: ${33.33 + barWidth/2}%` : 
                    `right: ${66.67 + barWidth/2}%`;
                const labelClass = isPositive ? 'positive' : 'negative';
                const labelHTML = `<div class="performance-bar-label ${labelClass}" style="${labelPosition};">${isPositive ? '+' : ''}${performance.toFixed(1)}%</div>`;
                
                return `
                    <div class="enhanced-performance-bar">
                        <div class="performance-bar-track">
                            <div class="performance-bar-center-new" style="left: 33.33%;"></div>
                            <div class="performance-bar-center-label-new" style="left: 33.33%;">0%</div>
                            ${barHTML}
                            ${labelHTML}
                            ${markers.join('')}
                        </div>
                    </div>
                `;
            }
            
            calculateEstimatedPnL(position, performance) {
                const estimatedValue = position.totalInvested * (1 + performance / 100);
                const pnl = estimatedValue - position.totalInvested;
                const sign = pnl >= 0 ? '+' : '';
                return `${sign}${pnl.toFixed(4)}`;
            }
            
            renderPerformanceBar(position) {
                // Garde l'ancienne fonction pour la compatibilité avec les positions fermées
                if (position.status !== 'OPEN') return '';
                return this.renderEnhancedPerformanceBar(position);
            }
            cleanupClosedPositions() {
                const openMints = (this.positionsData || []).filter(p => p.status === 'OPEN').map(p => p.mint);
                let hasChanges = false;
                for (const mint of performanceHistory.keys()) {
                    if (!openMints.includes(mint)) {
                        performanceHistory.delete(mint);
                        reachedMilestones.delete(mint);
                        hasChanges = true;
                    }
                }
                if (hasChanges) savePerformanceHistory();
            }
        }

        // ====================================================================================
        // FONCTIONS DE GESTION WEBSOCKET & PRIX TEMPS RÉEL
        // ====================================================================================
        function connectWebSocket() {
            try {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}`;
                ws = new WebSocket(wsUrl);
                ws.onopen = () => {
                    console.log('✅ WebSocket connecté');
                    reconnectAttempts = 0;
                    positionManager.updateConnectionStatus(true);
                    
                    // 🎯 CHARGER L'HISTORIQUE DES TP ATTEINTS
                    loadTpAchievedHistory();
                    
                    requestInitialData();
                };
                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        handleWebSocketMessage(data);
                    } catch (error) { console.error('Erreur parsing message:', error); }
                };
                ws.onclose = () => {
                    console.log('❌ WebSocket déconnecté');
                    positionManager.updateConnectionStatus(false);
                    attemptReconnect();
                };
                ws.onerror = (error) => {
                    console.error('Erreur WebSocket:', error);
                    positionManager.updateConnectionStatus(false);
                };
            } catch (error) {
                console.error('Erreur connexion WebSocket:', error);
                positionManager.updateConnectionStatus(false);
            }
        }
        function attemptReconnect() {
            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                console.log(`Tentative de reconnexion ${reconnectAttempts}/${maxReconnectAttempts}`);
                setTimeout(connectWebSocket, reconnectDelay * Math.pow(2, reconnectAttempts -1) );
            } else {
                console.error('❌ Impossible de se reconnecter après plusieurs tentatives.');
                showNotification('error', 'Connexion serveur perdue. Veuillez actualiser la page.');
            }
        }
        function requestInitialData() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'requestData' }));
            }
        }
        function handleWebSocketMessage(data) {
            console.log('📨 Message reçu:', data.type/*, data*/); // Commenté data pour alléger les logs
            switch (data.type) {
                case 'positionsUpdate': positionManager.updatePositions(data.data); break;
                case 'transactionUpdate': positionManager.updateTransactions(data.data); break;
                case 'healthUpdate': positionManager.updateHealth(data.data); break;
                case 'initialData':
                    positionManager.updatePositions(data.positions);
                    positionManager.updateTransactions(data.transactions);
                    positionManager.updateHealth(data.health);
                    if (data.realtimePrices) updateAllRealtimePrices(data.realtimePrices);
                    break;
                case 'realtimePriceUpdate': handleSingleRealtimePriceUpdate(data.data); break;
                default: console.log('Type de message inconnu:', data.type);
            }
            positionManager.updateLastUpdate();
        }
        function updateAllRealtimePrices(pricesData) {
            for (const [mint, priceData] of Object.entries(pricesData)) {
                realtimePrices.set(mint, priceData);
            }
            if (positionManager && positionManager.positionsData) {
                positionManager.renderPositionsTable(positionManager.positionsData);
            }
        }
        function handleSingleRealtimePriceUpdate(priceData) {
            const currentPriceData = realtimePrices.get(priceData.mint);
            if (currentPriceData) {
                previousPrices.set(priceData.mint, currentPriceData.price);
                if (priceData.price !== currentPriceData.price) {
                    updatePriceArrowVisual(priceData.mint, priceData.price > currentPriceData.price ? 'up' : 'down');
                }
            }
            realtimePrices.set(priceData.mint, priceData);
            if (positionManager && positionManager.positionsData) {
                 positionManager.renderPositionsTable(positionManager.positionsData);
            }
        }
        function updatePriceArrowVisual(mint, direction) {
            const existingArrow = priceArrows.get(mint);
            if (existingArrow && existingArrow.timeoutId) clearTimeout(existingArrow.timeoutId);
            const timeoutId = setTimeout(() => fadeOutPriceArrow(mint), 3000);
            priceArrows.set(mint, { direction, timestamp: Date.now(), timeoutId, fading: false });
        }
        function fadeOutPriceArrow(mint) {
            const arrowData = priceArrows.get(mint);
            if (arrowData) {
                arrowData.fading = true;
                setTimeout(() => {
                    priceArrows.delete(mint);
                    if (positionManager && positionManager.positionsData) positionManager.renderPositionsTable(positionManager.positionsData);
                }, 1000);
            }
        }
        function getCurrentPriceHTML(mint) {
            const priceData = realtimePrices.get(mint);
            if (!priceData || !priceData.price) return '<span style="color:#a0aec0;">-</span>';
            if ((Date.now() - priceData.timestamp) > 15000) return '<span style="color:#a0aec0;">(stale)</span>';
            
            let arrowHTML = '<span class="price-arrow" style="opacity:0;">&nbsp;</span>';
            const arrowData = priceArrows.get(mint);
            if (arrowData) {
                const arrowSymbol = arrowData.direction === 'up' ? '▲' : '▼';
                arrowHTML = `<span class="price-arrow ${arrowData.direction} ${arrowData.fading ? 'fading' : ''}">${arrowSymbol}</span>`;
            }
            
            // Ajouter la source du prix
            const source = priceData.source || 'unknown';
            let sourceColor = '#a0aec0';
            let sourceText = '';
            
            if (source === 'jupiter' || source === 'jupiter_batch') {
                sourceColor = '#00d4aa';
                sourceText = 'J';
            } else if (source === 'dexscreener' || source === 'DEXSCREENER') {
                sourceColor = '#3b82f6';
                sourceText = 'D';
            } else if (source === 'gmgn' || source === 'gmgn_realtime' || source === 'GMGN') {
                sourceColor = '#22c55e';
                sourceText = 'GMGN';
            } else {
                sourceText = '?';
            }
            
            return `${arrowHTML}$${priceData.price.toFixed(8)}<span style="color: ${sourceColor}; font-size: 0.7rem; font-weight: bold; margin-left: 4px; opacity: 0.8;" title="${source.toUpperCase()}">${sourceText}</span>`;
        }

        // ====================================================================================
        // FONCTIONS DE GESTION DE LA VENTE OPTIMISÉE (basé sur sell_all_tokens_fast.js)
        // ====================================================================================
        async function showSellModal(mint, tokenSymbol, tokenAmount) {
            currentSellData = null;
            document.getElementById('sellModal').style.display = 'block';
            document.getElementById('sellModalSubtitle').textContent = 'Préparation de la vente avec script sell_all_tokens_fast.js...';
            showSellLoading('Utilisation du script de vente fiable...');
            
            try {
                console.log(`🚀 Préparation vente directe pour ${tokenSymbol} (${mint})`);
                
                // Utiliser directement le script sell_all_tokens_fast.js via la route /api/sell-direct
                // Pas besoin de récupérer le solde ou le quote - le script gère tout automatiquement
                
                currentSellData = { 
                    mint, 
                    tokenSymbol, 
                    tokenAmount
                };
                
                // Afficher les informations du token et préparer la modal
                document.getElementById('sellTokenName').textContent = `${tokenSymbol} (Script Direct)`;
                document.getElementById('sellTokenAmount').textContent = `${positionManager.formatTokenAmount(tokenAmount)} tokens`;
                document.getElementById('sellEstimatedPrice').textContent = 'Calculé en temps réel';
                document.getElementById('sellEstimatedSOL').textContent = 'Optimisé par Jupiter';
                document.getElementById('sellEstimatedUSD').textContent = 'Quote automatique';
                document.getElementById('sellSlippage').textContent = '1.5% (dynamique)';
                document.getElementById('sellRoute').textContent = 'Script sell_all_tokens_fast.js';
                document.getElementById('sellFees').textContent = '~0.0005 SOL';
                
                // Afficher info sur le script direct
                const sellDetails = document.getElementById('sellDetails');
                sellDetails.innerHTML = `
                    <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid #22c55e; border-radius: 8px; padding: 12px; margin-bottom: 15px;">
                        <div style="color: #22c55e; font-weight: 600; font-size: 0.9rem; margin-bottom: 4px;">🚀 Script sell_all_tokens_fast.js</div>
                        <div style="color: #e2e8f0; font-size: 0.8rem; line-height: 1.4;">
                            • Logique identique au script en ligne de commande<br>
                            • Récupération automatique du solde exact<br>
                            • Quote Jupiter optimisé en temps réel<br>
                            • Signature et envoi automatiques<br>
                            • Retry automatique jusqu'à vente complète<br>
                            • Blockhash frais pour éviter l'expiration<br>
                            • Gestion intelligente des résidus
                        </div>
                    </div>
                `;
                
                hideSellLoading();
                document.getElementById('sellModalSubtitle').textContent = 'Script fiable - Cliquez pour exécuter la vente complète';
                
            } catch (error) {
                console.error('❌ Erreur préparation vente directe:', error);
                showSellError(`Erreur préparation: ${error.message}`);
            }
        }

        async function executeSell() {
            if (!currentSellData) {
                showSellError('Données de vente non disponibles.');
                return;
            }
            
            const { mint, tokenSymbol } = currentSellData;
            
            try {
                console.log(`🚀 Exécution vente directe via script pour ${tokenSymbol}...`);
                setSellButtonState(true, 'Vente en cours...');
                
                // Appeler la route /api/sell-direct qui utilise exactement le script sell_all_tokens_fast.js
                const response = await fetch('/api/sell-direct', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ mint })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('✅ Vente réussie:', result);
                    
                    let successMessage = `🎉 Vente ${result.completionRate === '100%' ? 'complète' : 'quasi-complète'}!<br>`;
                    successMessage += `💰 ${result.solReceived.toFixed(6)} SOL reçus<br>`;
                    
                    if (result.explorerUrl) {
                        successMessage += `<a href="${result.explorerUrl}" target="_blank" style="color:#c6f6d5;text-decoration:underline;">Voir sur Solscan</a><br>`;
                    }
                    
                    successMessage += `📊 Taux de completion: ${result.completionRate}<br>`;
                    
                    if (result.finalBalance > 0) {
                        successMessage += `⚠️ Résidu: ${result.finalBalance} tokens (${((result.finalBalance / result.initialBalance) * 100).toFixed(4)}%)`;
                    }
                    
                    showSellSuccess(successMessage);
                    
                    // Actualiser les données
                    requestInitialData();
                    
                    // Fermer la modal après 4 secondes
                    setTimeout(closeSellModal, 4000);
                    
                } else {
                    console.error('❌ Erreur vente:', result.error);
                    showSellError(`Erreur vente: ${result.error}`);
                }
                
            } catch (error) {
                console.error('❌ Erreur exécution vente directe:', error);
                showSellError(`Erreur réseau: ${error.message}`);
            }
        }

        // Supprimer les fonctions complexes non nécessaires
        function populateSellModalOptimized() {
            // Cette fonction n'est plus nécessaire avec le script direct
        }

        async function executeSellWithRetry() {
            // Cette fonction n'est plus nécessaire - le script gère les retries automatiquement
        }

        // ====================================================================================
        // GESTION MODAL DÉTAILS & HISTORIQUE PERFORMANCE
        // ====================================================================================
        async function showPositionDetails(mint) {
            if (!positionManager || !positionManager.positionsData) { console.error('Données de positions non disponibles'); return; }
            const position = positionManager.positionsData.find(p => p.mint === mint);
            if (!position) { console.error('Position non trouvée:', mint); return; }
            document.getElementById('modalContent').innerHTML = `<div class="loading"><div class="spinner"></div>Chargement données brutes...</div>`;
            document.getElementById('detailsModal').style.display = 'block';
            try {
                const rawTransactions = [];
                if (position.transactions && Array.isArray(position.transactions)) {
                    for (const tx of position.transactions) {
                        if (tx.signature) {
                            try {
                                const response = await fetch(`/api/transaction/${tx.signature}`);
                                if (response.ok) rawTransactions.push(await response.json());
                                else console.warn(`Tx brute non trouvée: ${tx.signature}, statut: ${response.status}`);
                            } catch (fetchError) { console.error(`Erreur fetch tx ${tx.signature}:`, fetchError); }
                        }
                    }
                }
                const completeAnalysisData = { positionCalculee: position, transactionsBrutes: rawTransactions, analysisObjective: "Vérifier la cohérence des données et les calculs de la position." };
                document.getElementById('modalContent').innerHTML = formatJsonWithSyntaxHighlighting(completeAnalysisData);
            } catch (error) {
                console.error('Erreur chargement détails:', error);
                document.getElementById('modalContent').innerHTML = `<div style="color:#fc8181;text-align:center;padding:40px;">❌ Erreur chargement.<br><small>${error.message}</small></div>`;
            }
        }
        function closeDetailsModal() { document.getElementById('detailsModal').style.display = 'none'; }

        // ====================================================================================
        // GESTION MODAL LOGS DE TRADING
        // ====================================================================================
        async function showTradeLogsModal(mint, tokenSymbol) {
            document.getElementById('modalContent').innerHTML = `<div class="loading"><div class="spinner"></div>Chargement logs de trading pour ${tokenSymbol}...</div>`;
            document.getElementById('detailsModal').style.display = 'block';
            
            try {
                console.log(`📊 Chargement logs pour token: ${tokenSymbol} (${mint})`);
                
                // Récupérer les logs pour ce token spécifique
                const response = await fetch(`/api/trade-logs/token?mint=${mint}&limit=50`);
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Erreur récupération logs');
                }
                
                const logs = result.logs || [];
                console.log(`📊 ${logs.length} logs trouvés pour ${tokenSymbol}`);
                
                // Générer le contenu HTML des logs
                const logsHtml = formatTradeLogsForDisplay(logs, tokenSymbol, mint);
                document.getElementById('modalContent').innerHTML = logsHtml;
                
            } catch (error) {
                console.error('❌ Erreur chargement logs:', error);
                document.getElementById('modalContent').innerHTML = `
                    <div style="color:#fc8181;text-align:center;padding:40px;">
                        ❌ Erreur chargement des logs<br>
                        <small>${error.message}</small><br><br>
                        <i>Note: Les logs de trading sont disponibles uniquement pour les tokens échangés après l'implémentation du système de logging.</i>
                    </div>
                `;
            }
        }

        function formatTradeLogsForDisplay(logs, tokenSymbol, mint) {
            if (!logs || logs.length === 0) {
                return `
                    <div style="text-align:center;padding:40px;color:#a0aec0;">
                        <h3>📊 Logs de Trading - ${tokenSymbol}</h3>
                        <div style="margin-top:20px;">
                            <p>🔍 Aucun log de trading trouvé pour ce token</p>
                            <small style="color:#718096;">
                                Les logs sont enregistrés automatiquement pour tous les achats et ventes.<br>
                                Si ce token a été échangé avant l'implémentation du système de logging, aucun historique ne sera disponible.
                            </small>
                        </div>
                    </div>
                `;
            }

            // Séparer les achats et ventes
            const buyLogs = logs.filter(log => log.type === 'BUY');
            const sellLogs = logs.filter(log => log.type === 'SELL' || log.type === 'SELL_ERROR');
            
            // Calculer des statistiques
            const totalBuys = buyLogs.length;
            const totalSells = sellLogs.filter(log => log.type === 'SELL').length;
            const totalErrors = sellLogs.filter(log => log.type === 'SELL_ERROR').length;
            const totalInvested = buyLogs.reduce((sum, log) => sum + (log.solAmount || 0), 0);
            const totalReceived = sellLogs.filter(log => log.type === 'SELL').reduce((sum, log) => sum + (log.solReceived || 0), 0);
            
            let html = `
                <div class="trade-logs-container">
                    <div class="logs-header">
                        <h3>📊 Logs de Trading - ${tokenSymbol}</h3>
                        <div class="logs-stats">
                            <span class="stat-item">💰 ${totalBuys} achats</span>
                            <span class="stat-item">💸 ${totalSells} ventes</span>
                            ${totalErrors > 0 ? `<span class="stat-item error">❌ ${totalErrors} erreurs</span>` : ''}
                            <span class="stat-item">📈 ${totalInvested.toFixed(4)} SOL investi</span>
                            ${totalReceived > 0 ? `<span class="stat-item">📉 ${totalReceived.toFixed(4)} SOL reçu</span>` : ''}
                        </div>
                    </div>
                    
                    <div class="logs-content">
            `;

            // Afficher tous les logs par ordre chronologique inverse
            const sortedLogs = logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            sortedLogs.forEach(log => {
                const date = new Date(log.timestamp).toLocaleString('fr-FR');
                let logClass = 'log-entry';
                let logIcon = '📝';
                let logTitle = log.type;
                
                if (log.type === 'BUY') {
                    logClass += ' log-buy';
                    logIcon = '💰';
                    logTitle = 'ACHAT';
                } else if (log.type === 'SELL') {
                    logClass += ' log-sell';
                    logIcon = '💸';
                    logTitle = 'VENTE';
                } else if (log.type === 'SELL_ERROR') {
                    logClass += ' log-error';
                    logIcon = '❌';
                    logTitle = 'ERREUR VENTE';
                }

                html += `
                    <div class="${logClass}">
                        <div class="log-header">
                            <span class="log-icon">${logIcon}</span>
                            <span class="log-title">${logTitle}</span>
                            <span class="log-date">${date}</span>
                        </div>
                        <div class="log-details">
                            ${formatLogDetails(log)}
                        </div>
                    </div>
                `;
            });

            html += `
                    </div>
                    <div class="logs-footer">
                        <small>💡 Logs automatiques depuis l'implémentation du système de traçabilité</small>
                    </div>
                </div>
                
                <style>
                    .trade-logs-container { padding: 20px; }
                    .logs-header { margin-bottom: 20px; border-bottom: 1px solid #4a5568; padding-bottom: 15px; }
                    .logs-header h3 { margin: 0 0 10px 0; color: #e2e8f0; }
                    .logs-stats { display: flex; gap: 15px; flex-wrap: wrap; }
                    .stat-item { background: #2d3748; padding: 5px 10px; border-radius: 5px; font-size: 0.8rem; color: #a0aec0; }
                    .stat-item.error { background: #742a2a; color: #feb2b2; }
                    .logs-content { max-height: 400px; overflow-y: auto; }
                    .log-entry { margin-bottom: 15px; border: 1px solid #4a5568; border-radius: 8px; overflow: hidden; }
                    .log-buy { border-left: 4px solid #48bb78; }
                    .log-sell { border-left: 4px solid #4299e1; }
                    .log-error { border-left: 4px solid #f56565; }
                    .log-header { background: #2d3748; padding: 10px 15px; display: flex; align-items: center; gap: 10px; }
                    .log-icon { font-size: 1.2rem; }
                    .log-title { font-weight: 600; color: #e2e8f0; flex-grow: 1; }
                    .log-date { font-size: 0.8rem; color: #a0aec0; }
                    .log-details { padding: 15px; background: #1a202c; }
                    .log-detail-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
                    .log-detail-label { color: #a0aec0; }
                    .log-detail-value { color: #e2e8f0; font-weight: 500; }
                    .logs-footer { margin-top: 20px; text-align: center; padding-top: 15px; border-top: 1px solid #4a5568; color: #718096; }
                </style>
            `;

            return html;
        }

        function formatLogDetails(log) {
            // Si le log a un message simplifié, l'afficher directement
            if (log.message) {
                return `
                    <div class="log-simple-message">
                        ${log.message}
                    </div>
                    ${log.signature ? `
                    <div class="log-detail-row" style="margin-top: 10px;">
                        <span class="log-detail-label">🔗 Transaction:</span>
                        <span class="log-detail-value">
                            <a href="https://solscan.io/tx/${log.signature}" target="_blank" style="color: #90cdf4; text-decoration: none;">
                                ${log.signature.substring(0, 16)}...
                            </a>
                        </span>
                    </div>
                    ` : ''}
                    <style>
                        .log-simple-message {
                            font-family: 'IBM Plex Mono', monospace;
                            font-size: 0.9rem;
                            line-height: 1.4;
                            color: #e2e8f0;
                            background: #2d3748;
                            padding: 12px;
                            border-radius: 6px;
                            border-left: 3px solid #4299e1;
                        }
                    </style>
                `;
            }
            
            // Format classique pour compatibilité
            let details = '';
            
            if (log.type === 'BUY') {
                details = `
                    <div class="log-detail-row">
                        <span class="log-detail-label">💰 Montant SOL:</span>
                        <span class="log-detail-value">${log.solAmount?.toFixed(6) || '-'} SOL</span>
                    </div>
                    <div class="log-detail-row">
                        <span class="log-detail-label">🪙 Tokens reçus:</span>
                        <span class="log-detail-value">${log.tokenAmount ? log.tokenAmount.toLocaleString() : '-'}</span>
                    </div>
                    <div class="log-detail-row">
                        <span class="log-detail-label">💱 Prix/token:</span>
                        <span class="log-detail-value">${log.pricePerToken?.toFixed(10) || '-'} SOL</span>
                    </div>
                    <div class="log-detail-row">
                        <span class="log-detail-label">🏪 Plateforme:</span>
                        <span class="log-detail-value">${log.platform || 'Unknown'}</span>
                    </div>
                    ${log.signature ? `
                    <div class="log-detail-row">
                        <span class="log-detail-label">🔗 Transaction:</span>
                        <span class="log-detail-value">
                            <a href="https://solscan.io/tx/${log.signature}" target="_blank" style="color: #90cdf4; text-decoration: none;">
                                ${log.signature.substring(0, 16)}...
                            </a>
                        </span>
                    </div>
                    ` : ''}
                `;
            } else if (log.type === 'SELL') {
                details = `
                    <div class="log-detail-row">
                        <span class="log-detail-label">📊 Pourcentage vendu:</span>
                        <span class="log-detail-value">${log.percentage || '-'}%</span>
                    </div>
                    <div class="log-detail-row">
                        <span class="log-detail-label">🪙 Tokens vendus:</span>
                        <span class="log-detail-value">${log.tokensSold ? log.tokensSold.toLocaleString() : '-'}</span>
                    </div>
                    <div class="log-detail-row">
                        <span class="log-detail-label">💰 SOL reçu:</span>
                        <span class="log-detail-value">${log.solReceived?.toFixed(6) || '-'} SOL</span>
                    </div>
                    <div class="log-detail-row">
                        <span class="log-detail-label">📈 Performance:</span>
                        <span class="log-detail-value ${(log.sellPerformance || 0) >= 0 ? 'color: #48bb78' : 'color: #f56565'}">
                            ${log.sellPerformance ? (log.sellPerformance > 0 ? '+' : '') + log.sellPerformance.toFixed(2) + '%' : '-'}
                        </span>
                    </div>
                    ${log.executionTime ? `
                    <div class="log-detail-row">
                        <span class="log-detail-label">⏱️ Temps exécution:</span>
                        <span class="log-detail-value">${log.executionTime}ms</span>
                    </div>
                    ` : ''}
                    <div class="log-detail-row">
                        <span class="log-detail-label">🏪 Plateforme:</span>
                        <span class="log-detail-value">${log.platform || 'Unknown'}</span>
                    </div>
                    ${log.signature ? `
                    <div class="log-detail-row">
                        <span class="log-detail-label">🔗 Transaction:</span>
                        <span class="log-detail-value">
                            <a href="https://solscan.io/tx/${log.signature}" target="_blank" style="color: #90cdf4; text-decoration: none;">
                                ${log.signature.substring(0, 16)}...
                            </a>
                        </span>
                    </div>
                    ` : ''}
                `;
            } else if (log.type === 'SELL_ERROR') {
                details = `
                    <div class="log-detail-row">
                        <span class="log-detail-label">📊 Pourcentage tenté:</span>
                        <span class="log-detail-value">${log.percentage || '-'}%</span>
                    </div>
                    <div class="log-detail-row">
                        <span class="log-detail-label">❌ Erreur:</span>
                        <span class="log-detail-value" style="color: #f56565;">${log.errorMessage || '-'}</span>
                    </div>
                    <div class="log-detail-row">
                        <span class="log-detail-label">🏷️ Type erreur:</span>
                        <span class="log-detail-value">${log.errorType || 'UNKNOWN'}</span>
                    </div>
                    ${log.retryAttempt ? `
                    <div class="log-detail-row">
                        <span class="log-detail-label">🔄 Tentative:</span>
                        <span class="log-detail-value">${log.retryAttempt}</span>
                    </div>
                    ` : ''}
                    <div class="log-detail-row">
                        <span class="log-detail-label">🏪 Plateforme:</span>
                        <span class="log-detail-value">${log.platform || 'Unknown'}</span>
                    </div>
                `;
            }

            return details;
        }
        function formatJsonWithSyntaxHighlighting(obj) {
            const jsonString = JSON.stringify(obj, null, 2);
            return jsonString.replace(/(".*?")(\s*:)/g, '<span class="json-key">$1</span>$2').replace(/:\s*(".*?")/g, ': <span class="json-string">$1</span>').replace(/:\s*(\d+\.?\d*)/g, ': <span class="json-number">$1</span>').replace(/:\s*(true|false)/g, ': <span class="json-boolean">$1</span>').replace(/:\s*(null)/g, ': <span class="json-null">$1</span>');
        }
        function loadPerformanceHistory() {
            fetch('/api/performance-history')
                .then(response => response.ok ? response.json() : Promise.reject(response.statusText))
                .then(data => {
                    if (data.success && data.history) {
                        performanceHistory.clear();
                        reachedMilestones.clear();
                        Object.entries(data.history).forEach(([mint,hist]) => performanceHistory.set(mint,hist));
                        Object.entries(data.milestones || {}).forEach(([mint,miles]) => reachedMilestones.set(mint,miles));
                        console.log('✅ Historique performance chargé:', performanceHistory.size, 'positions.');
                    } else { console.log('ℹ️ Pas d\'historique performance valide trouvé.');}
                })
                .catch(error => console.log('ℹ️ Pas d\'historique de performance (ou erreur chargement):', error));
        }
        function savePerformanceHistory() {
            const historyData = { history:Object.fromEntries(performanceHistory), milestones:Object.fromEntries(reachedMilestones), timestamp:Date.now() };
            fetch('/api/performance-history', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(historyData) })
            .then(response => response.ok ? response.json() : Promise.reject(response.statusText))
            .then(data => { if(data.success) console.log('💾 Historique performance sauvegardé.'); })
            .catch(error => console.error('❌ Erreur sauvegarde performance:', error));
        }
        function updateMilestones(mint, performancePercent) {
            const gainSteps = [100, 200, 300, 400, 500];
            const lossSteps = [25, 50, 75, 100];
            let milestonesData = reachedMilestones.get(mint) || { gainMilestones:[], lossMilestones:[] };
            let hasNewMilestone = false;
            if (performancePercent > 0) {
                gainSteps.forEach(step => { if (performancePercent >= step && !milestonesData.gainMilestones.includes(step)) { milestonesData.gainMilestones.push(step); hasNewMilestone = true; } });
            } else {
                lossSteps.forEach(step => { if (performancePercent <= -step && !milestonesData.lossMilestones.includes(step)) { milestonesData.lossMilestones.push(step); hasNewMilestone = true; } });
            }
            if (hasNewMilestone) {
                reachedMilestones.set(mint, milestonesData);
                savePerformanceHistory();
            }
            return milestonesData;
        }

        // ====================================================================================
        // DÉMARRAGE ET GESTION ÉVÉNEMENTS GLOBAUX
        // ====================================================================================
        document.addEventListener('DOMContentLoaded', () => {
            // 🎯 CHARGER L'HISTORIQUE DES TP ATTEINTS EN PRIORITÉ
            loadTpAchievedHistory();
            
            positionManager = new PositionManager();
            connectWebSocket();
            loadPerformanceHistory();
            
            // Gestion des modales
            window.onclick = function(event) {
                const detailsModal = document.getElementById('detailsModal');
                if (event.target === detailsModal) closeDetailsModal();
            }
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    closeDetailsModal();
                }
            });
        });



        // ====================================================================================
        // FONCTIONS DE VENTE INSTANTANÉE (script sell_all_tokens_fast.js)
        // ====================================================================================
        async function executeSellDirectly(mint, tokenSymbol, tokenAmount) {
            console.log(`🚀 VENTE DIRECTE via script: ${tokenSymbol} (${mint.substring(0,8)}...)`);
            
            // Notification de début
            showNotification('info', `🔄 Vente ${tokenSymbol} - Script intelligent avec retry automatique...`, 3000);
            
            try {
                // Appel de la route /api/sell-direct qui utilise exactement le script sell_all_tokens_fast.js
                console.log('⚡ Exécution via script serveur (logique identique au script CLI)...');
                const response = await fetch('/api/sell-direct', {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ mint })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Succès !
                    const { signature, solReceived, initialBalance, finalBalance, completionRate, explorerUrl } = result;
                    
                    let message;
                    if (completionRate === '100%' || finalBalance === 0) {
                        message = `🎉 ${tokenSymbol} vendu complètement! ${solReceived.toFixed(6)} SOL reçus`;
                    } else {
                        message = `🎉 ${tokenSymbol} vendu ${completionRate}! ${solReceived.toFixed(6)} SOL reçus`;
                    }
                    
                    showNotification('success', message, 6000);
                    
                    // Log des détails
                    console.log(`✅ Transaction: ${signature}`);
                    console.log(`💰 SOL reçus: ${solReceived}`);
                    console.log(`📊 Completion: ${completionRate}`);
                    if (explorerUrl) {
                        console.log(`🔗 Explorer: ${explorerUrl}`);
                    }
                    
                    // Rafraîchir l'interface
                    requestInitialData();
                    
                } else {
                    throw new Error(result.error || 'Erreur inconnue');
                }
                
            } catch (error) {
                console.error('❌ Erreur vente directe:', error);
                
                let errorMsg;
                if (error.message.includes('PRIVATE_KEY')) {
                    errorMsg = `❌ Configuration serveur manquante (PRIVATE_KEY)`;
                } else if (error.message.includes('Aucun token')) {
                    errorMsg = `❌ ${tokenSymbol}: Aucun token trouvé dans le portefeuille`;
                } else if (error.message.includes('0x1771')) {
                    errorMsg = `❌ ${tokenSymbol}: Slippage excessif ou liquidité insuffisante. Le script a tenté plusieurs fois automatiquement.`;
                } else if (error.message.includes('Rate limit')) {
                    errorMsg = `❌ ${tokenSymbol}: API Jupiter temporairement surchargée. Retry automatique effectué.`;
                } else if (error.message.includes('Jupiter')) {
                    errorMsg = `❌ ${tokenSymbol}: API Jupiter temporairement indisponible`;
                } else if (error.message.includes('block height exceeded')) {
                    errorMsg = `❌ ${tokenSymbol}: Blockhash expiré (retries automatiques effectués)`;
                } else if (error.message.includes('simulation failed')) {
                    errorMsg = `❌ ${tokenSymbol}: Simulation échouée malgré les retries (problème de liquidité)`;
                } else {
                    errorMsg = `❌ ${tokenSymbol}: ${error.message}`;
                }
                
                showNotification('error', errorMsg, 8000);
            }
        }

        // ====================================================================================
        // FONCTIONS MODAL SIMPLIFIÉES (utilisant le script direct)
        // ====================================================================================
        async function openSellModal(mint, tokenSymbol, tokenAmount) {
            // Rediriger vers showSellModal qui utilise maintenant le script direct
            await showSellModal(mint, tokenSymbol, tokenAmount);
        }

        // Supprimer les fonctions complexes non nécessaires
        async function executeSellWithRetryDirect() {
            // Cette fonction n'est plus nécessaire - le script gère les retries automatiquement
        }

        function setSellButtonState(disabled, text) {
            // Fonction désactivée pour vente instantanée
        }
        function showSellLoading(message) {
            // Fonction désactivée pour vente instantanée
        }
        function hideSellLoading() {
            // Fonction désactivée pour vente instantanée
        }
        function showSellError(message) {
            // Fonction désactivée pour vente instantanée
        }
        function showSellSuccess(message) {
            // Fonction désactivée pour vente instantanée
        }
        function closeSellModal() {
            // Fonction désactivée pour vente instantanée
        }

        // ====================================================================================
        // NOUVELLES FONCTIONS VENTES PARTIELLES & TIMER
        // ====================================================================================
        
        let fastSellTimers = new Map(); // Stockage des timers rapides ⚡25%
        
        // ====================================================================================
        // SYSTÈME TAKE PROFIT AUTOMATIQUE ÉTAGÉ + STOP LOSS
        // ====================================================================================
        
        let takeProfitActive = new Map(); // Stockage de l'état TP par mint (false, 'high', 'small')
        let takeProfitTriggered = new Map(); // Positions qui ont déjà déclenché les TP (objet avec niveaux)
        
        // Variable pour gérer l'état des positions fermées dépliées
        const expandedClosedPositions = new Set(); // Set des mints des positions fermées dépliées
        
        // 🎯 STOCKAGE PERSISTANT DES TP ATTEINTS - pour conserver l'info après refresh
        // Structure: { mint: { grid: 'high'|'small', levels: ['tp1', 'tp2', ...], timestamps: {...} } }
        const tpAchievedHistory = new Map();
        
        // Sauvegarder l'historique des TP atteints dans localStorage
        function saveTpAchievedHistory() {
            try {
                const data = Array.from(tpAchievedHistory.entries());
                localStorage.setItem('tpAchievedHistory', JSON.stringify(data));
                console.log('💾 Historique TP sauvegardé');
            } catch (error) {
                console.error('❌ Erreur sauvegarde historique TP:', error);
            }
        }
        
        // Charger l'historique des TP atteints depuis localStorage
        function loadTpAchievedHistory() {
            try {
                const stored = localStorage.getItem('tpAchievedHistory');
                if (stored) {
                    const data = JSON.parse(stored);
                    data.forEach(([mint, info]) => tpAchievedHistory.set(mint, info));
                    console.log(`📂 Historique TP chargé: ${data.length} positions`);
                }
            } catch (error) {
                console.error('❌ Erreur chargement historique TP:', error);
            }
        }
        
        // Marquer un TP comme atteint et sauvegarder
        function markTpAchieved(mint, tpLevel, gridType, timestamp = Date.now()) {
            const existing = tpAchievedHistory.get(mint) || { 
                grid: gridType, 
                levels: [], 
                timestamps: {} 
            };
            
            if (!existing.levels.includes(tpLevel)) {
                existing.levels.push(tpLevel);
                existing.timestamps[tpLevel] = timestamp;
                existing.grid = gridType; // Mettre à jour la grille actuelle
                
                tpAchievedHistory.set(mint, existing);
                saveTpAchievedHistory();
                
                console.log(`🎯 TP ${tpLevel} marqué comme atteint pour ${mint.substring(0, 8)}... (grille ${gridType})`);
            }
        }
        
        // Vérifier si un TP spécifique a été atteint
        function isTpAchieved(mint, tpLevel) {
            const achieved = tpAchievedHistory.get(mint);
            return achieved && achieved.levels.includes(tpLevel);
        }
        
        // Obtenir toutes les informations TP pour un mint
        function getTpAchievedInfo(mint) {
            return tpAchievedHistory.get(mint) || null;
        }
        
        // Configuration des grilles Take Profit et Stop Loss multiples
        const TP_GRIDS = {
            'high': {
                name: 'High',
                color: '#10b981',
                levels: [
                    { threshold: 100, percentage: 25, label: "TP1 +100%", color: "#10b981" },
                    { threshold: 200, percentage: 25, label: "TP2 +200%", color: "#059669" },
                    { threshold: 500, percentage: 25, label: "TP3 +500%", color: "#047857" },
                    { threshold: 1000, percentage: 25, label: "TP4 +1000%", color: "#065f46" }
                ],
                stopLoss: { threshold: -50, percentage: 100, label: "SL -50%", color: "#dc2626" }
            },
            'small': {
                name: 'Small',
                color: '#3b82f6',
                levels: [
                    { threshold: 10, percentage: 25, label: "TP1 +10%", color: "#3b82f6" },
                    { threshold: 25, percentage: 25, label: "TP2 +25%", color: "#2563eb" },
                    { threshold: 75, percentage: 25, label: "TP3 +75%", color: "#1d4ed8" },
                    { threshold: 100, percentage: 25, label: "TP4 +100%", color: "#1e40af" }
                ],
                stopLoss: { threshold: -50, percentage: 100, label: "SL -50%", color: "#dc2626" }
            }
        };
        
        // Activer automatiquement le take profit pour un nouveau token (grille High par défaut)
        function enableTakeProfitByDefault(mint) {
            takeProfitActive.set(mint, 'high');
            takeProfitTriggered.set(mint, {
                tp1: false, tp2: false, tp3: false, tp4: false, sl: false
            });
            console.log(`🎯 Grille High activée par défaut pour: ${mint.substring(0, 8)}...`);
        }
        
        // Cycle entre les grilles TP/SL : OFF → High → Small → OFF
        function toggleTakeProfit(mint) {
            const currentGrid = takeProfitActive.get(mint) || false;
            let nextGrid, nextText, nextColor, notificationMessage;
            
            // Cycle des grilles
            if (currentGrid === false) {
                nextGrid = 'high';
                nextText = 'HIGH';
                nextColor = TP_GRIDS.high.color;
                notificationMessage = `🎯 Grille HIGH activée: TP +100%/+200%/+500%/+1000% (25% chacun) + SL -50%`;
            } else if (currentGrid === 'high') {
                nextGrid = 'small';
                nextText = 'SMALL';
                nextColor = TP_GRIDS.small.color;
                notificationMessage = `🎯 Grille SMALL activée: TP +10%/+25%/+75%/+100% (25% chacun) + SL -50%`;
            } else {
                nextGrid = false;
                nextText = 'TP OFF';
                nextColor = '#64748b';
                notificationMessage = `ℹ️ Take Profit désactivé`;
            }
            
            // Appliquer le changement
            takeProfitActive.set(mint, nextGrid);
            
            // Réinitialiser les niveaux déclenchés si on active une grille
            if (nextGrid !== false) {
                takeProfitTriggered.set(mint, {
                    tp1: false, tp2: false, tp3: false, tp4: false, sl: false
                });
            }
            
            // Mettre à jour le bouton
            const buttonElement = document.querySelector(`[data-mint="${mint}"] .tp-btn-center`);
            if (buttonElement) {
                const textElement = buttonElement.querySelector('.tp-text-center');
                const iconElement = buttonElement.querySelector('.tp-icon-center');
                
                textElement.textContent = nextText;
                buttonElement.style.backgroundColor = nextColor;
                buttonElement.style.borderColor = nextColor;
                
                if (nextGrid !== false) {
                    buttonElement.classList.add('active');
                    iconElement.textContent = nextGrid === 'high' ? '🚀' : '⚡';
                } else {
                    buttonElement.classList.remove('active');
                    iconElement.textContent = '🎯';
                }
            }
            
            // Notification
            const type = nextGrid !== false ? 'success' : 'info';
            showNotification(type, `${notificationMessage} pour ${getTokenSymbol(mint)}`, 6000);
            
            console.log(`🎯 Grille ${nextGrid || 'OFF'} activée pour ${mint.substring(0, 8)}...`);
        }
        
        // Surveiller les positions en temps réel pour le TP automatique avec grilles multiples
        function checkTakeProfitTriggers() {
            if (!positionManager.positionsData) return;
            
            positionManager.positionsData.forEach(position => {
                if (position.status !== 'OPEN') return;
                
                const mint = position.mint;
                const activeGrid = takeProfitActive.get(mint);
                const triggeredLevels = takeProfitTriggered.get(mint) || {};
                
                // Vérifier si une grille TP est activée
                if (!activeGrid || activeGrid === false) return;
                
                // Récupérer la grille active
                const currentGrid = TP_GRIDS[activeGrid];
                if (!currentGrid) return;
                
                // Calculer la performance actuelle
                const priceData = realtimePrices.get(mint);
                if (!priceData?.price || !position.averagePriceUSD) return;
                
                // Vérifier que les données ne sont pas trop anciennes (15 secondes max)
                if ((Date.now() - priceData.timestamp) > 15000) return;
                
                const performance = ((priceData.price - position.averagePriceUSD) / position.averagePriceUSD) * 100;
                
                // Vérifier Stop Loss en priorité
                if (performance <= currentGrid.stopLoss.threshold && !triggeredLevels.sl) {
                    triggerStopLoss(mint, performance, position, currentGrid.stopLoss, activeGrid);
                    return; // Stop ici si SL déclenché
                }
                
                // Vérifier chaque niveau de Take Profit (du plus élevé au plus bas)
                for (let i = currentGrid.levels.length - 1; i >= 0; i--) {
                    const level = currentGrid.levels[i];
                    const levelKey = `tp${i + 1}`;
                    
                    if (performance >= level.threshold && !triggeredLevels[levelKey]) {
                        triggerTakeProfit(mint, performance, position, level, levelKey, i + 1, activeGrid);
                        break; // Déclencher un seul niveau à la fois
                    }
                }
            });
        }
        
        // Déclencher le take profit automatique avec grilles multiples
        async function triggerTakeProfit(mint, performance, position, level, levelKey, levelNumber, gridType) {
            try {
                // Marquer ce niveau comme déclenché
                const triggeredLevels = takeProfitTriggered.get(mint) || {};
                triggeredLevels[levelKey] = true;
                takeProfitTriggered.set(mint, triggeredLevels);
                
                // 🎯 ENREGISTRER LE TP ATTEINT DE FAÇON PERSISTANTE
                markTpAchieved(mint, levelKey, gridType);
                
                const tokenSymbol = getTokenSymbol(mint);
                const gridName = TP_GRIDS[gridType].name.toUpperCase();
                
                console.log(`🎯 ${gridName} ${level.label} DÉCLENCHÉ! ${tokenSymbol} a atteint +${performance.toFixed(1)}%`);
                
                // Notification importante avec grille et niveau
                const icon = gridType === 'high' ? '🚀' : '⚡';
                showNotification('success', 
                    `${icon} ${gridName} ${level.label}! ${tokenSymbol} +${performance.toFixed(1)}% → Vente ${level.percentage}% automatique`, 
                    8000 // 8 secondes
                );
                
                // Mettre à jour l'interface
                const statusElement = document.querySelector(`[data-mint="${mint}"] .tp-status-new`);
                if (statusElement) {
                    const currentGrid = TP_GRIDS[gridType];
                    const remainingLevels = currentGrid.levels.length - levelNumber;
                    statusElement.textContent = remainingLevels > 0 ? `${remainingLevels} Restants` : 'Tous Exécutés';
                    statusElement.style.color = level.color;
                }
                
                // Lancer la vente optimisée
                await initiateOptimizedSell(mint, level.percentage);
                
                // Log détaillé
                console.log(`📊 ${gridName} ${level.label} Exécuté: ${tokenSymbol} | Performance: +${performance.toFixed(1)}% | Montant vendu: ${level.percentage}%`);
                
            } catch (error) {
                console.error(`❌ Erreur ${gridName} ${level.label} pour ${mint.substring(0, 8)}...:`, error);
                showNotification('error', `Erreur ${gridName} ${level.label}: ${error.message}`);
                
                // Réinitialiser ce niveau en cas d'erreur
                const triggeredLevels = takeProfitTriggered.get(mint) || {};
                triggeredLevels[levelKey] = false;
                takeProfitTriggered.set(mint, triggeredLevels);
            }
        }
        
        // Déclencher le stop loss automatique avec grilles multiples
        async function triggerStopLoss(mint, performance, position, stopLossConfig, gridType) {
            try {
                // Marquer le SL comme déclenché
                const triggeredLevels = takeProfitTriggered.get(mint) || {};
                triggeredLevels.sl = true;
                takeProfitTriggered.set(mint, triggeredLevels);
                
                const tokenSymbol = getTokenSymbol(mint);
                const gridName = TP_GRIDS[gridType].name.toUpperCase();
                
                console.log(`🛑 ${gridName} STOP LOSS DÉCLENCHÉ! ${tokenSymbol} a chuté à ${performance.toFixed(1)}%`);
                
                // Notification critique avec grille
                showNotification('error', 
                    `🛑 ${gridName} STOP LOSS! ${tokenSymbol} ${performance.toFixed(1)}% → Vente COMPLÈTE automatique`, 
                    10000 // 10 secondes
                );
                
                // Mettre à jour l'interface
                const statusElement = document.querySelector(`[data-mint="${mint}"] .tp-status-new`);
                if (statusElement) {
                    statusElement.textContent = 'SL EXEC';
                    statusElement.style.color = stopLossConfig.color;
                }
                
                // Désactiver les TP pour cette position
                takeProfitActive.set(mint, false);
                const buttonElement = document.querySelector(`[data-mint="${mint}"] .tp-btn-center`);
                if (buttonElement) {
                    buttonElement.classList.remove('active');
                    buttonElement.querySelector('.tp-text-center').textContent = 'SL EXEC';
                    buttonElement.querySelector('.tp-icon-center').textContent = '🛑';
                    buttonElement.style.backgroundColor = stopLossConfig.color;
                }
                
                // Lancer la vente COMPLÈTE
                await initiateOptimizedSell(mint, stopLossConfig.percentage);
                
                // Log détaillé
                console.log(`📊 ${gridName} Stop Loss Exécuté: ${tokenSymbol} | Performance: ${performance.toFixed(1)}% | Montant vendu: ${stopLossConfig.percentage}%`);
                
            } catch (error) {
                console.error(`❌ Erreur ${gridName} Stop Loss pour ${mint.substring(0, 8)}...:`, error);
                showNotification('error', `Erreur ${gridName} Stop Loss: ${error.message}`);
                
                // Réinitialiser le SL en cas d'erreur
                const triggeredLevels = takeProfitTriggered.get(mint) || {};
                triggeredLevels.sl = false;
                takeProfitTriggered.set(mint, triggeredLevels);
            }
        }
        
        // Obtenir le symbole d'un token
        function getTokenSymbol(mint) {
            const position = positionManager.positionsData?.find(p => p.mint === mint);
            return position?.tokenSymbol || position?.tokenName || mint.substring(0, 8) + '...';
        }
        
        // Fonction pour gérer le dépliage des positions fermées
        function toggleClosedPositionDetails(mint) {
            if (expandedClosedPositions.has(mint)) {
                expandedClosedPositions.delete(mint);
                console.log(`📉 Position fermée repliée: ${mint.substring(0, 8)}...`);
            } else {
                expandedClosedPositions.add(mint);
                console.log(`📈 Position fermée dépliée: ${mint.substring(0, 8)}...`);
            }
            
            // Recharger l'affichage des positions pour mettre à jour
            if (positionManager && positionManager.positionsData) {
                positionManager.renderPositionsTable(positionManager.positionsData);
            }
        }
        
        // Démarrer la surveillance automatique du TP
        setInterval(checkTakeProfitTriggers, 2000); // Vérifier toutes les 2 secondes
        

        
        async function initiateOptimizedSell(mint, percentage) {
            console.log(`⚡ Vente OPTIMISÉE ${percentage}% initiée pour: ${mint.substring(0, 8)}...`);
            
            // Obtenir les informations de la position
            const position = positionManager.positionsData.find(p => p.mint === mint);
            if (!position) {
                showNotification('error', 'Position non trouvée');
                return;
            }
            
            const tokenSymbol = position.tokenSymbol || position.tokenName || 'Token';
            
            // Désactiver tous les boutons de vente pour cette position
            const card = document.querySelector(`[data-mint="${mint}"]`);
            if (card) {
                const buttons = card.querySelectorAll('.sell-btn');
                buttons.forEach(btn => {
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                    btn.style.cursor = 'not-allowed';
                });
            }
            
            // Démarrer le timer spécial pour vente rapide
            startFastSellTimer(mint);
            
            // Notification de début avec indicateur optimisé
            showNotification('info', `⚡ Vente ULTRA-RAPIDE ${percentage}% ${tokenSymbol} - Traitement...`, 3000);
            
            try {
                // Appel API pour vente optimisée avec timeout plus court
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 secondes seulement
                
                const response = await fetch('/api/close-trade/execute-ultra-optimized', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        mint,
                        sellPercentage: percentage
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                // Vérifier d'abord le statut HTTP de la réponse
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Erreur HTTP ${response.status}: ${errorText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    const { signature, executionTimeMs, method, confirmed, quoteAge } = result;
                    
                    // Arrêter le timer rapide avec le temps exact du serveur
                    stopFastSellTimerWithTime(mint, executionTimeMs);
                    
                    let message = `🎉 ULTRA-RAPIDE: ${percentage}% de ${tokenSymbol} vendu! `;
                    if (executionTimeMs) message += `${(executionTimeMs / 1000).toFixed(2)}s`;
                    if (method) message += ` (${method})`;
                    if (quoteAge && method === 'OPTIMIZED') message += ` [Quote: ${quoteAge}s]`;
                    
                    showNotification('success', message, 8000);
                    
                    console.log(`✅ Vente OPTIMISÉE ${percentage}% réussie:`, {
                        signature,
                        executionTimeMs,
                        method,
                        confirmed,
                        quoteAge
                    });
                    
                    // Rafraîchir l'interface
                    requestInitialData();
                    
                } else {
                    // En cas d'échec, afficher l'erreur mais avec les détails d'exécution
                    const errorMsg = result.error || 'Erreur inconnue';
                    const timing = result.executionTimeMs ? ` (${(result.executionTimeMs / 1000).toFixed(2)}s)` : '';
                    const method = result.method ? ` [${result.method}]` : '';
                    
                    throw new Error(`${errorMsg}${timing}${method}`);
                }
                
            } catch (error) {
                console.error('❌ Erreur vente optimisée:', error);
                
                // Arrêter le timer rapide en cas d'erreur
                stopFastSellTimer(mint);
                
                // Gestion spécifique des erreurs optimisées
                if (error.name === 'AbortError') {
                    showNotification('warning', 
                        `⏱️ Vente OPTIMISÉE ${percentage}% ${tokenSymbol}: Délai dépassé. 
                        Vérification en cours...`, 
                        6000);
                    
                    // Rafraîchir plus rapidement pour vérifier l'état
                    setTimeout(() => {
                        requestInitialData();
                    }, 3000);
                    
                } else {
                    let errorMsg = `❌ Vente OPTIMISÉE ${percentage}% ${tokenSymbol}: `;
                    if (error.message.includes('Aucun quote chaud')) {
                        errorMsg += 'Système de pré-calcul non prêt - Réessayez dans quelques secondes';
                    } else if (error.message.includes('Quote trop ancien')) {
                        errorMsg += 'Données périmées - Recalcul en cours';
                    } else if (error.message.includes('Solde a changé')) {
                        errorMsg += 'Solde modifié - Recalcul automatique effectué';
                    } else {
                        errorMsg += error.message || 'Erreur système';
                    }
                    
                    showNotification('error', errorMsg, 8000);
                }
                
            } finally {
                // Réactiver les boutons de vente après un délai court
                setTimeout(() => {
                    if (card) {
                        const buttons = card.querySelectorAll('.sell-btn');
                        buttons.forEach(btn => {
                            btn.disabled = false;
                            btn.style.opacity = '1';
                            btn.style.cursor = 'pointer';
                        });
                    }
                }, 1500); // 1.5 secondes de délai pour la version optimisée
            }
        }
        

        
        // Timer spécial pour les ventes rapides ⚡25%
        function startFastSellTimer(mint) {
            const timerElement = document.getElementById(`fast-timer-${mint}`);
            const timerValueElement = timerElement?.querySelector('.fast-timer-value');
            
            if (!timerElement || !timerValueElement) return;
            
            // Afficher le timer
            timerElement.style.display = 'flex';
            
            // Démarrer le chronométrage
            const startTime = Date.now();
            
            const intervalId = setInterval(() => {
                const elapsed = (Date.now() - startTime) / 1000;
                timerValueElement.textContent = `${elapsed.toFixed(2)}s`;
            }, 50); // Mise à jour plus fréquente pour plus de précision
            
            // Stocker l'ID de l'intervalle
            fastSellTimers.set(mint, {
                intervalId,
                startTime,
                element: timerElement
            });
        }
        
        function stopFastSellTimer(mint) {
            const timer = fastSellTimers.get(mint);
            if (!timer) return;
            
            // Arrêter le timer
            clearInterval(timer.intervalId);
            
            // Calculer le temps final
            const finalTime = (Date.now() - timer.startTime) / 1000;
            const timerValueElement = timer.element.querySelector('.fast-timer-value');
            if (timerValueElement) {
                timerValueElement.textContent = `${finalTime.toFixed(2)}s`;
                
                // Changer le style pour indiquer que c'est terminé
                timer.element.style.background = 'rgba(72, 187, 120, 0.15)';
                timer.element.style.borderColor = '#48bb78';
                timer.element.style.color = '#48bb78';
                timer.element.style.animation = 'none';
            }
            
            // Garder le timer visible plus longtemps (10 secondes) pour pouvoir lire le résultat
            setTimeout(() => {
                if (timer.element) {
                    timer.element.style.display = 'none';
                    // Remettre les styles originaux pour la prochaine fois
                    timer.element.style.background = 'rgba(255, 193, 7, 0.15)';
                    timer.element.style.borderColor = '#ffc107';
                    timer.element.style.color = '#ffc107';
                    timer.element.style.animation = 'pulse-fast-timer 0.8s ease-in-out infinite';
                }
                fastSellTimers.delete(mint);
            }, 10000); // 10 secondes au lieu de 3
        }
        
        // Version spéciale qui utilise le temps exact du serveur
        function stopFastSellTimerWithTime(mint, serverExecutionTimeMs) {
            const timer = fastSellTimers.get(mint);
            if (!timer) return;
            
            // Arrêter le timer
            clearInterval(timer.intervalId);
            
            const timerValueElement = timer.element.querySelector('.fast-timer-value');
            if (timerValueElement && serverExecutionTimeMs) {
                // Utiliser le temps exact du serveur
                timerValueElement.textContent = `${(serverExecutionTimeMs / 1000).toFixed(2)}s`;
                
                // Changer le style pour indiquer que c'est terminé avec succès
                timer.element.style.background = 'rgba(72, 187, 120, 0.2)';
                timer.element.style.borderColor = '#48bb78';
                timer.element.style.color = '#48bb78';
                timer.element.style.animation = 'none';
                timer.element.style.fontWeight = 'bold';
            }
            
            // Garder le timer visible encore plus longtemps (15 secondes) pour bien voir le résultat
            setTimeout(() => {
                if (timer.element) {
                    timer.element.style.display = 'none';
                    // Remettre les styles originaux pour la prochaine fois
                    timer.element.style.background = 'rgba(255, 193, 7, 0.15)';
                    timer.element.style.borderColor = '#ffc107';
                    timer.element.style.color = '#ffc107';
                    timer.element.style.animation = 'pulse-fast-timer 0.8s ease-in-out infinite';
                    timer.element.style.fontWeight = '600';
                }
                fastSellTimers.delete(mint);
            }, 15000); // 15 secondes pour bien lire le résultat
        }
        
        // Fonction utilitaire pour formater le timing des ventes
        function formatSellTiming(timings) {
            if (!timings) return '';
            
            const parts = [];
            if (timings.submission) parts.push(`Submit: ${timings.submission}ms`);
            if (timings.confirmation) parts.push(`Confirm: ${timings.confirmation}ms`);
            if (timings.update) parts.push(`Update: ${timings.update}ms`);
            
            return parts.length > 0 ? ` (${parts.join(', ')})` : '';
        }
        

        
    </script>
</body>
</html> 
</html> 
</html> 